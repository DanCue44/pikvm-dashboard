<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PiKVM Control Dashboard</title>
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <style>
        :root {
            --bg-primary: #1e1e1e;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #3a3a3a;
        }

        [data-theme="light"] {
            --bg-primary: #e3f2fd;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f5f5f5;
            --text-primary: #1e1e1e;
            --text-secondary: #3a3a3a;
            --border-color: #999999;
        }

        /* Wizard/Settings/Login/Modals always stay in dark mode regardless of theme */
        .setup-wizard,
        .login-container,
        .modal {
            --bg-primary: #1e1e1e;
            --bg-secondary: #2a2a2a;
            --bg-tertiary: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #3a3a3a;
        }

        /* Login Form Styles */
        .login-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .login-container.show {
            display: flex;
        }

        .login-box {
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-width: 400px;
            width: 90%;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo img {
            height: 60px;
        }

        .login-title {
            font-size: 1.8em;
            text-align: center;
            margin-bottom: 30px;
            color: var(--text-primary);
        }

        .login-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .login-input:focus {
            outline: none;
            border-color: #ff6b35;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #ff6b35, #ff8c00);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .login-error {
            background: #ef4444;
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* Setup Wizard Styles */
        .setup-wizard {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10001;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .setup-wizard.show {
            display: flex !important;
        }

        .wizard-container {
            background: var(--bg-secondary);
            border-radius: 20px;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            overflow: hidden;
            margin: 20px auto;
        }

        .wizard-header {
            background: linear-gradient(135deg, #ff8c00, #ff6a00);
            padding: 30px;
            text-align: center;
            color: white;
            border-radius: 20px 20px 0 0;
        }

        .wizard-header h1 {
            margin: 0;
            font-size: 2em;
            font-weight: 600;
        }

        .wizard-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        .wizard-progress {
            display: flex;
            justify-content: space-between;
            padding: 20px 30px;
            background: var(--bg-tertiary);
            border-bottom: 2px solid var(--border-color);
        }

        .wizard-step-indicator {
            flex: 1;
            text-align: center;
            position: relative;
            padding: 10px;
        }

        .wizard-step-indicator::before {
            content: '';
            position: absolute;
            top: 30px; /* Center of 40px circle (20px) + 10px padding = 30px */
            left: 0;
            right: 0;
            height: 2px;
            background: var(--border-color);
            z-index: 0;
        }

        .wizard-step-indicator:first-child::before {
            left: 50%;
        }

        .wizard-step-indicator:last-child::before {
            right: 50%;
        }

        .wizard-step-number {
            display: inline-block;
            width: 40px;
            height: 40px;
            line-height: 40px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        /* Custom Confirmation Dialog */
        .confirm-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 10002;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .confirm-dialog.show {
            display: flex !important;
        }

        .confirm-box {
            background: var(--bg-secondary);
            border-radius: 15px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
            overflow: hidden;
        }

        .confirm-header {
            background: linear-gradient(135deg, #ff6b35, #ff8c00);
            padding: 25px;
            text-align: center;
            color: white;
        }

        .confirm-header h2 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 600;
        }

        .confirm-body {
            padding: 30px;
            color: var(--text-primary);
            text-align: center;
            font-size: 1.1em;
            line-height: 1.6;
        }

        .confirm-buttons {
            display: flex;
            gap: 15px;
            padding: 0 30px 30px 30px;
        }

        .confirm-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .confirm-btn-yes {
            background: linear-gradient(135deg, #ff6b35, #ff8c00);
            color: white;
        }

        .confirm-btn-yes:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 107, 53, 0.4);
        }

        .confirm-btn-no {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .confirm-btn-no:hover {
            background: var(--bg-secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .wizard-step-indicator.active .wizard-step-number {
            background: linear-gradient(135deg, #ff8c00, #ff6a00);
            border-color: #ff8c00;
            color: white;
        }

        .wizard-step-indicator.completed .wizard-step-number {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .wizard-step-label {
            display: block;
            margin-top: 10px;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .wizard-step-indicator.active .wizard-step-label {
            color: #ff8c00;
            font-weight: 600;
        }

        .wizard-body {
            padding: 40px;
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
        }

        .wizard-step {
            display: none;
        }

        .wizard-step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wizard-step h2 {
            margin: 0 0 10px 0;
            color: var(--text-primary);
            font-size: 1.8em;
        }

        .wizard-step p {
            margin: 0 0 30px 0;
            color: var(--text-secondary);
        }
        
        /* Step 1 specific styles */
        .step1-header {
            position: relative;
            padding-right: 220px;
            margin-bottom: 20px;
            min-height: 120px;
        }
        
        .step1-header h2 {
            margin-bottom: 10px;
        }
        
        .step1-header p {
            margin-bottom: 0;
        }
        
        .step1-image {
            position: absolute;
            top: 0;
            right: 0;
            max-width: 200px;
            width: 200px;
            border-radius: 8px;
        }
        
        .step1-content {
            margin-top: 0;
        }

        .wizard-input-group {
            margin-bottom: 25px;
        }

        .wizard-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .wizard-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .wizard-input:focus {
            outline: none;
            border-color: #ff6b35;
        }

        .wizard-radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .wizard-radio-option {
            flex: 1;
            padding: 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .wizard-radio-option:hover {
            border-color: #ff6b35;
            background: var(--bg-tertiary);
        }

        .wizard-radio-option.selected {
            border-color: #ff6b35;
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(255, 140, 0, 0.1));
        }

        .wizard-radio-option input[type="radio"] {
            display: none;
        }

        .wizard-radio-label {
            font-size: 1.2em;
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
        }

        .wizard-radio-desc {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .pc-config-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .pc-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .pc-config-number {
            background: linear-gradient(135deg, #ff6b35, #ff8c00);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .icon-selector {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .icon-option {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-size: 2em;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
        }

        .icon-option:hover {
            border-color: #ff6b35;
            transform: scale(1.1);
        }

        .icon-option.selected {
            border-color: #ff6b35;
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.2), rgba(255, 140, 0, 0.2));
        }

        .icon-upload-box {
            cursor: pointer;
            position: relative;
        }

        .icon-upload-box:hover {
            border-color: #ff8c00;
        }

        /* Custom tooltip for upload box */
        .icon-upload-box[title]:hover::before {
            content: attr(title);
            position: absolute;
            bottom: 105%;
            left: 50%;
            transform: translateX(-50%);
            background: #ff8c00;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(255, 140, 0, 0.4);
            animation: tooltipFadeIn 0.15s ease-out;
            pointer-events: none;
            
            /* Smart edge handling */
            max-width: 200px;
            width: max-content;
            white-space: normal;
            text-align: center;
            word-wrap: break-word;
        }

        /* Left-aligned tooltip when near right edge */
        .icon-selector > .icon-upload-box:nth-last-child(-n+2)[title]:hover::before {
            left: auto;
            right: 0;
            transform: translateX(0);
        }

        /* Right-aligned tooltip when near left edge */
        .icon-selector > .icon-upload-box:nth-child(-n+2)[title]:hover::before {
            left: 0;
            right: auto;
            transform: translateX(0);
        }

        .icon-upload-box[title]:hover::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #ff8c00;
            z-index: 1000;
            pointer-events: none;
        }

        /* Arrow positioning for edge-aligned tooltips */
        .icon-selector > .icon-upload-box:nth-last-child(-n+2)[title]:hover::after {
            left: auto;
            right: 12px;
            transform: translateX(0);
        }

        .icon-selector > .icon-upload-box:nth-child(-n+2)[title]:hover::after {
            left: 12px;
            right: auto;
            transform: translateX(0);
        }

        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                bottom: 110%;
            }
            to {
                opacity: 1;
                bottom: 105%;
            }
        }

        .upload-preview-container {
            display: none;
            width: 100%;
            height: 100%;
            align-items: center;
            justify-content: center;
        }

        .upload-icon-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .color-picker-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .color-picker-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Color picker styling - remove default white border */
        input[type="color"] {
            border: none;
            padding: 0;
            background: transparent;
        }
        
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 6px;
        }
        
        input[type="color"]::-moz-color-swatch {
            border: none;
            border-radius: 6px;
        }

        .color-preview {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
        }

        .preset-themes {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .theme-preset {
            padding: 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .theme-preset:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .theme-preset.selected {
            border-color: #ff6b35;
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(255, 140, 0, 0.1));
        }

        .theme-colors {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 10px;
        }

        .theme-color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .feature-toggle-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .feature-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #888;
            transition: 0.4s;
            border-radius: 24px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #ff6b35;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .wizard-footer {
            padding: 20px 40px;
            background: var(--bg-tertiary);
            border-top: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
        }

        .wizard-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .wizard-btn-secondary {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
        }

        .wizard-btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        .wizard-btn-primary {
            background: linear-gradient(135deg, #ff6b35, #ff8c00);
            color: white;
        }

        .wizard-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.4);
        }

        .wizard-btn:disabled {
            opacity: 1;
            cursor: not-allowed;
            background: #666 !important;
            color: #999 !important;
        }

        .wizard-btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .main-content {
            display: none;
        }

        .main-content.show {
            display: block;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', 'DejaVu Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s, color 0.3s;
        }

        .container {
            width: 100%;
            max-width: 800px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
        }
        
        .header-grid {
            display: grid;
            grid-template-columns: 150px 1fr 150px;
            align-items: center;
            width: 100%;
            margin-bottom: 15px;
        }
        
        .header-logo-link {
            display: flex;
            align-items: center;
            text-decoration: none;
            justify-self: start;
        }
        
        .header-logo {
            height: 50px;
            width: auto;
            cursor: pointer;
        }
        
        .header-title {
            font-size: 2.5em;
            margin: 0;
            font-weight: 500;
            color: #e0e0e0;
            text-align: center;
        }
        
        .header-menu {
            display: flex;
            justify-content: flex-end;
        }

        [data-theme="light"] .header-title {
            color: #2d2d2d;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .hamburger-btn {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 16px;
            cursor: pointer;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.5em;
            transition: all 0.3s ease;
            line-height: 1;
        }

        .hamburger-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border-color: #ff6b35;
        }
        
        /* Scroll to Top Button */
        .scroll-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
        }
        
        .scroll-to-top:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.5);
            background: #2a2a2a;
            border-color: #ff6b35;
        }
        
        .scroll-to-top svg {
            width: 24px;
            height: 24px;
            stroke: #ffffff;
            stroke-width: 3;
            fill: none;
        }
        
        .scroll-to-top.show {
            display: flex;
        }

        .menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10003;
            align-items: stretch;
            justify-content: flex-end;
        }

        .menu-overlay.show {
            display: flex;
        }

        .menu-content {
            background: var(--bg-secondary);
            border-radius: 0;
            box-shadow: -10px 0 30px rgba(0,0,0,0.8);
            width: 100%;
            max-width: 350px;
            height: 100%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 2px solid var(--border-color);
        }

        .menu-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.5em;
        }

        .menu-close {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.8em;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .menu-close:hover {
            color: #ff6b35;
            transform: rotate(90deg);
        }

        .menu-items {
            padding: 10px 0;
        }

        .menu-item-with-toggle {
            display: flex;
            align-items: center;
            padding-right: 20px;
        }

        .menu-item-with-toggle:hover {
            background: var(--bg-tertiary);
        }

        .menu-item-with-toggle .menu-item {
            flex: 1;
            padding-right: 10px;
        }

        .menu-item-with-toggle .menu-item:hover {
            background: none;
        }

        .menu-toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }

        .menu-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .menu-toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #888;
            transition: .3s;
            border-radius: 24px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .menu-toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        .menu-toggle input:checked + .menu-toggle-slider {
            background-color: #ff8c00;
        }

        .menu-toggle input:checked + .menu-toggle-slider:before {
            transform: translateX(20px);
        }

        .menu-item {
            width: 100%;
            padding: 15px 25px;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.1em;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.2s ease;
            text-align: left;
        }

        .menu-item:hover {
            background: var(--bg-tertiary);
        }

        .menu-item span:first-child {
            font-size: 1.3em;
            width: 30px;
            text-align: center;
        }

        .menu-item-danger {
            color: #ef4444;
        }

        .menu-item-danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 10px 0;
        }

        .theme-toggle, .sound-toggle {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 15px;
            cursor: pointer;
            color: var(--text-primary);
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover, .sound-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .pc-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 20px;
            justify-content: space-between;
        }
        
        .pc-cards {
            display: contents;
        }

        .pc-card {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 22px 30px 30px 30px;
            width: calc(50% - 15px);
            max-width: calc(50% - 15px);
            flex-shrink: 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: transform 0.3s ease;
        }

        .pc-card:hover {
            transform: translateY(-5px);
        }

        .pc-name {
            font-size: 1.5em;
            font-weight: 500;
            margin-bottom: 12px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }

        .pc-icon {
            font-size: 1.8em;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            min-width: 80px;
            min-height: 45px;
        }

        .pc-icon.media {
            font-size: 1.8em;
        }

        .pc-icon.media img {
            width: 30px;
            height: 30px;
            object-fit: contain;
        }

        .pc-icon.gaming img {
            width: 80px;
            height: 45px;
            object-fit: contain;
        }

        .status-indicator {
            display: block;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }

        .status-indicators {
            display: flex;
            flex-direction: column;
            gap: 4px;
            position: relative;
            min-height: 60px;
            padding-bottom: 0;
        }

        .led-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .led-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
        }

        .led-dot.active {
            background: #60a5fa;
            box-shadow: 0 0 8px #60a5fa;
            animation: pulse 1s infinite;
        }

        .status-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            animation: pulse 2s infinite;
            flex-shrink: 0;
        }

        .status-dot.on {
            background: #4ade80;
            box-shadow: 0 0 10px #4ade80;
        }

        .status-dot.off {
            background: #ef4444;
            box-shadow: 0 0 10px #ef4444;
        }

        .status-dot.checking {
            background: #fbbf24;
            box-shadow: 0 0 10px #fbbf24;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-text {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .status-text.processing {
            color: #fbbf24;
            font-style: italic;
        }

        .countdown {
            font-size: 0.9em;
            color: #888;
            margin-top: 5px;
        }

        .countdown.processing {
            color: #fbbf24;
            font-weight: 600;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .button-grid .btn-reset {
            grid-column: 1 / -1;
        }

        .btn {
            flex: 1;
            min-width: 120px;
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

        .btn-on {
            background: linear-gradient(135deg, #4ade80, #22c55e);
            color: white;
        }

        .btn-off {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-reset {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        /* Shortcuts Section */
        .shortcuts-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        .shortcuts-title {
            font-size: 1.2em;
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .shortcut-btn {
            padding: 12px 15px;
            background: linear-gradient(135deg, #ff6b35, #ff8c00);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .shortcut-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .shortcut-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

        .pc-selector {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 1em;
            margin-bottom: 15px;
        }

        /* Scheduled Actions Section */
        .scheduled-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        .scheduled-title {
            font-size: 1.2em;
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .schedule-form {
            display: block;
            margin-bottom: 15px;
        }

        .schedule-input {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 1em;
            height: 48px;
            box-sizing: border-box;
        }

        .schedule-input:focus {
            outline: none;
            border-color: #ff6b35;
        }

        /* Lighter spinner arrows for number inputs */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 0.6;
        }
        
        input[type="number"]:hover::-webkit-inner-spin-button,
        input[type="number"]:hover::-webkit-outer-spin-button {
            opacity: 1;
        }
        
        /* Brighter arrows for idle minutes on dark background */
        .idle-minutes-input::-webkit-inner-spin-button,
        .idle-minutes-input::-webkit-outer-spin-button {
            filter: invert(0.8) brightness(1.5);
        }
        
        .idle-minutes-input:hover::-webkit-inner-spin-button,
        .idle-minutes-input:hover::-webkit-outer-spin-button {
            filter: invert(1) brightness(2);
        }

        .schedule-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .schedule-list:not(:empty) {
            min-height: 240px;
        }

        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 3px solid #ff6b35;
        }

        .schedule-info {
            flex: 1;
        }

        .schedule-time {
            font-weight: 600;
            color: var(--text-primary);
        }

        .schedule-details {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 3px;
        }

        .schedule-countdown {
            font-size: 0.85em;
            color: #ff6b35;
            font-weight: 600;
        }

        .day-checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            user-select: none;
        }

        .day-checkbox-label:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 152, 0, 0.3);
        }

        .day-checkbox-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #ff9800;
        }

        .day-checkbox-label input[type="checkbox"]:checked + span {
            color: #ff9800;
            font-weight: 600;
        }

        .day-checkbox-label:has(input:checked) {
            background: rgba(255, 152, 0, 0.15);
            border-color: #ff9800;
        }
        
        /* Light mode adjustments for day checkboxes */
        [data-theme="light"] .day-checkbox-label {
            background: rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.15);
        }
        
        [data-theme="light"] .day-checkbox-label:hover {
            background: rgba(0, 0, 0, 0.06);
            border-color: rgba(255, 152, 0, 0.5);
        }
        
        [data-theme="light"] .day-checkbox-label:has(input:checked) {
            background: rgba(255, 152, 0, 0.12);
            border-color: #e68a00;
        }
        
        /* Recurring options box */
        .recurring-options-box {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        [data-theme="light"] .recurring-options-box {
            background: rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0, 0, 0, 0.12);
        }
        
        /* Important banner styling */
        .important-banner {
            background: rgba(255, 152, 0, 0.1);
            color: var(--text-secondary);
        }
        
        [data-theme="light"] .important-banner {
            background: rgba(255, 152, 0, 0.15);
            color: #4a4a4a;
        }
        
        /* Schedule item row styling */
        .schedule-item-row {
            background: rgba(255, 255, 255, 0.03);
        }
        
        [data-theme="light"] .schedule-item-row {
            background: rgba(0, 0, 0, 0.03);
        }

        .btn-remove {
            padding: 6px 12px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-remove:hover {
            transform: translateY(-2px);
        }

        /* Idle Shutdown Section */
        .idle-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        .idle-title {
            font-size: 1.2em;
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .idle-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .idle-card {
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }

        .idle-card-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-bottom: 10px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #888;
            transition: 0.4s;
            border-radius: 24px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #ff8c00;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .idle-status {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .idle-status.active {
            color: #4ade80;
            font-weight: 600;
        }

        .config-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        .config-title {
            font-size: 1.2em;
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .config-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .config-input:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .btn-save {
            width: 100%;
            padding: 10px 12px;
            height: 43px;
            background: linear-gradient(135deg, #ff6b35, #ff8c00);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        /* Modal Buttons */
        .btn-modal {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .btn-modal-cancel {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }

        .btn-modal-cancel:hover {
            background: linear-gradient(135deg, #4b5563, #374151);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-modal-confirm {
            background: linear-gradient(135deg, #ff6b35, #ff8c00);
            color: white;
        }

        .btn-modal-confirm:hover {
            background: linear-gradient(135deg, #ff8c00, #ff9500);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 140, 0, 0.3);
        }

        .btn-clear {
            width: 100%;
            padding: 10px 12px;
            height: 43px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .btn-clear:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 600;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            background: #4ade80;
            color: #065f46;
        }

        .toast.error {
            background: #ef4444;
            color: #7f1d1d;
        }

        .toast.info {
            background: #60a5fa;
            color: #1e3a8a;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .modal-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .modal-text {
            margin-bottom: 20px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            flex-direction: column;
        }

        .modal-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .modal-btn-secondary {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .modal-btn-cancel {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: 6px;
            font-size: 0.85em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
            border: 1px solid var(--border-color);
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        .action-log {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-top: 20px;
        }

        .action-log-title {
            font-size: 1.2em;
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .action-log-items {
            max-height: 250px;
            overflow-y: auto;
        }

        .action-log-item {
            padding: 10px;
            margin-bottom: 8px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 3px solid #4ade80;
            font-size: 0.9em;
        }

        .action-log-item.shutdown {
            border-left-color: #ef4444;
        }

        .action-log-item.reset {
            border-left-color: #f59e0b;
        }

        .action-log-time {
            color: var(--text-secondary);
            font-size: 0.85em;
        }

        @media (max-width: 768px) {
            /* Body and container - full width for shadow visibility */
            body {
                padding: 0 !important;
                align-items: flex-start !important;
            }
            
            .container {
                max-width: 100% !important;
                width: 100% !important;
                padding: 15px !important;
                overflow: visible !important;
            }
            
            /* PC Cards - stack vertically on mobile with proper padding */
            .pc-grid {
                padding: 0 5px !important;
            }
            
            .pc-card {
                width: 100% !important;
                max-width: 100% !important;
                margin-bottom: 5px !important;
            }
            
            .schedule-form {
                grid-template-columns: 1fr;
            }
            
            /* Stack schedule dropdowns vertically on mobile */
            #schedule-dropdowns-row {
                grid-template-columns: 1fr !important;
            }
            
            /* Stack PC/Action dropdowns vertically on mobile */
            .schedule-form > div:first-child {
                grid-template-columns: 1fr !important;
            }
            
            /* Stack recurring options vertically on mobile */
            #recurring-options > div {
                grid-template-columns: 1fr !important;
            }
            
            .idle-config {
                grid-template-columns: 1fr;
            }
            
            /* Shortcuts grid - 2 columns on mobile */
            .shortcuts-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* Day checkboxes - 2 columns on mobile */
            #day-of-week-selector > div {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            /* ========== HEADER MOBILE FIXES ========== */
            .header {
                flex-direction: column;
                gap: 10px;
                padding: 0 10px;
            }
            
            /* ========== HEADER MOBILE - Logo centered, title below ========== */
            .header-grid {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                gap: 8px !important;
                position: relative !important;
            }
            
            .header-logo-link {
                justify-self: center !important;
            }
            
            .header-logo {
                height: 60px !important;
            }
            
            .header-title {
                font-size: 1.6em !important;
                text-align: center !important;
                order: 2 !important;
            }
            
            .header-menu {
                position: absolute !important;
                top: 0 !important;
                right: 0 !important;
            }
            
            .hamburger-btn {
                padding: 12px 14px !important;
                font-size: 1.4em !important;
            }
            
            .hamburger-btn svg {
                width: 28px !important;
                height: 28px !important;
            }
            
            .header-controls {
                width: 100%;
                justify-content: center;
            }
            
            .theme-toggle, .sound-toggle {
                padding: 6px 12px;
                font-size: 0.85em;
            }
            
            /* Scroll to top - mobile position */
            .scroll-to-top {
                bottom: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
            }
            
            /* Modal adjustments for mobile */
            .modal-content {
                width: 95%;
                max-width: 95%;
                margin: 10px;
            }
            
            /* Button adjustments */
            .shortcut-btn, .btn-save, .btn-modal {
                font-size: 0.9em;
                padding: 10px 12px;
            }
            
            /* ========== SCHEDULE FORM MOBILE ========== */
            /* Prevent horizontal overflow only inside schedule sections */
            .scheduled-section,
            .schedule-form {
                overflow-x: hidden !important;
            }
            
            /* Date/Time and Condition - stack on mobile */
            #datetime-condition-row {
                grid-template-columns: 1fr !important;
                overflow: hidden !important;
            }
            
            #datetime-condition-row > div {
                overflow: hidden !important;
                max-width: 100% !important;
                width: 100% !important;
            }
            
            /* Prevent datetime input from overflowing */
            .schedule-input {
                max-width: 100% !important;
                box-sizing: border-box !important;
                width: 100% !important;
            }
            
            input[type="datetime-local"],
            input[type="datetime-local"].schedule-input,
            #schedule-time {
                width: 100% !important;
                max-width: 100% !important;
                min-width: 0 !important;
                font-size: 14px !important;
                box-sizing: border-box !important;
                -webkit-appearance: none !important;
                appearance: none !important;
            }
            
            /* ========== WIZARD MOBILE FIXES ========== */
            .setup-wizard {
                padding: 0 !important;
                align-items: stretch !important;
                justify-content: stretch !important;
            }
            
            .wizard-container {
                margin: 0 !important;
                max-width: 100% !important;
                width: 100% !important;
                height: 100vh !important;
                max-height: 100vh !important;
                border-radius: 0 !important;
                display: flex !important;
                flex-direction: column !important;
                overflow: hidden !important;
            }
            
            .wizard-header {
                padding: 15px 15px 12px 15px !important;
                border-radius: 0 !important;
                flex-shrink: 0 !important;
            }
            
            .wizard-header h1 {
                font-size: 1.25em !important;
            }
            
            .wizard-header p {
                font-size: 0.8em !important;
                margin-top: 4px !important;
            }
            
            /* Progress bar - full width with connecting lines */
            .wizard-progress {
                padding: 12px 10px !important;
                flex-shrink: 0 !important;
                justify-content: space-between !important;
                gap: 0 !important;
                overflow: visible !important;
            }
            
            .wizard-step-indicator {
                flex: 1 1 0 !important;
                min-width: 0 !important;
                padding: 5px 2px !important;
                position: relative !important;
            }
            
            .wizard-step-indicator::before {
                display: block !important;
                content: '' !important;
                position: absolute !important;
                top: 50% !important;
                left: 0 !important;
                right: 0 !important;
                height: 2px !important;
                background: var(--border-color) !important;
                transform: translateY(-50%) !important;
                z-index: 0 !important;
            }
            
            .wizard-step-indicator:first-child::before {
                left: 50% !important;
            }
            
            .wizard-step-indicator:last-child::before {
                right: 50% !important;
            }
            
            .wizard-step-number {
                width: 32px !important;
                height: 32px !important;
                line-height: 1 !important;
                font-size: 0.85em !important;
                position: relative !important;
                z-index: 1 !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
                box-sizing: border-box !important;
            }
            
            .wizard-step-label {
                display: none !important;
            }
            
            .wizard-body {
                padding: 15px !important;
                min-height: 0 !important;
                max-height: none !important;
                flex: 1 1 auto !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
            }
            
            .wizard-step {
                padding: 0 !important;
            }
            
            .wizard-step h2 {
                font-size: 1.2em !important;
                margin-bottom: 5px !important;
            }
            
            .wizard-step p {
                font-size: 0.85em !important;
                margin-bottom: 12px !important;
            }
            
            /* Step 1 mobile layout - image below text */
            .step1-header {
                position: static !important;
                padding-right: 0 !important;
                text-align: center !important;
                min-height: auto !important;
            }
            
            .step1-header h2 {
                text-align: left !important;
            }
            
            .step1-header p {
                text-align: left !important;
                margin-bottom: 15px !important;
            }
            
            .step1-image {
                position: static !important;
                display: block !important;
                max-width: 140px !important;
                width: auto !important;
                margin: 0 auto 15px auto !important;
            }
            
            .step1-content {
                margin-top: 0 !important;
            }
            
            .wizard-input-group {
                margin-bottom: 12px !important;
            }
            
            .wizard-radio-group {
                flex-direction: column !important;
                gap: 10px !important;
            }
            
            .wizard-radio-option {
                padding: 12px !important;
            }
            
            .wizard-radio-label {
                font-size: 1em !important;
            }
            
            .wizard-radio-desc {
                font-size: 0.8em !important;
            }
            
            .wizard-footer {
                flex-shrink: 0 !important;
                padding: 12px !important;
                border-radius: 0 !important;
                display: flex !important;
                flex-direction: column !important;
                gap: 8px !important;
            }
            
            .wizard-footer > button:first-child {
                order: 2 !important;
            }
            
            .wizard-footer > div {
                display: flex !important;
                flex-direction: column !important;
                gap: 8px !important;
                width: 100% !important;
                order: 1 !important;
            }
            
            .wizard-footer button,
            .wizard-btn {
                width: 100% !important;
                margin: 0 !important;
                padding: 12px 16px !important;
                font-size: 0.9em !important;
                box-sizing: border-box !important;
            }
            
            /* PC Config cards in wizard */
            .pc-config-card {
                padding: 12px !important;
            }
            
            .pc-config-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 8px !important;
            }
            
            /* Icon selector - 6 per row, dynamic sizing, fill all space */
            .icon-selector {
                display: grid !important;
                grid-template-columns: repeat(6, 1fr) !important;
                gap: 4px !important;
                width: 100% !important;
                max-width: 100% !important;
                overflow: hidden !important;
                box-sizing: border-box !important;
            }
            
            .icon-option {
                width: 100% !important;
                aspect-ratio: 1 / 1 !important;
                height: auto !important;
                padding: 3px !important;
                margin: 0 !important;
                min-height: unset !important;
                font-size: 1.3em !important;
                box-sizing: border-box !important;
                overflow: hidden !important;
            }
            
            .icon-option img {
                max-width: 75% !important;
                max-height: 75% !important;
                width: auto !important;
                height: auto !important;
            }
            
            .icon-upload-box svg {
                width: 20px !important;
                height: 20px !important;
            }
            
            /* Prevent wizard body overflow */
            .wizard-body,
            .wizard-step,
            .wizard-input-group,
            .pc-config-card {
                max-width: 100% !important;
                overflow-x: hidden !important;
            }
            
            /* Appearance - color pickers side by side */
            #color-customization-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 10px !important;
            }
            
            #color-customization-grid h3 {
                font-size: 0.9em !important;
                margin-bottom: 10px !important;
            }
            
            #color-customization-grid .color-picker {
                height: 35px !important;
            }
            
            #color-customization-grid label {
                font-size: 0.75em !important;
            }
            
            /* Appearance theme grid */
            .preset-themes {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 8px !important;
            }
            
            .theme-preset {
                padding: 10px 6px !important;
            }
            
            /* Feature toggles - fix alignment */
            .feature-toggle-list {
                grid-template-columns: 1fr !important;
                gap: 8px !important;
            }
            
            .feature-toggle {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                padding: 12px !important;
            }
            
            .feature-toggle span {
                flex: 1 !important;
            }
            
            .feature-toggle .toggle-switch {
                flex-shrink: 0 !important;
            }
            
            /* Color picker items */
            .color-picker-group {
                grid-template-columns: 1fr !important;
            }
            
            /* Confirmation dialog mobile */
            .confirm-box {
                width: 90%;
                padding: 20px;
            }
            
            /* Review step features grid - single column on mobile */
            .review-features-grid {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 480px) {
            .header-logo {
                height: 50px !important;
            }
            
            .header-title {
                font-size: 1.3em !important;
            }
            
            .hamburger-btn {
                padding: 10px 12px !important;
            }
            
            .hamburger-btn svg {
                width: 24px !important;
                height: 24px !important;
            }
            
            .shortcuts-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            .wizard-step-label {
                display: none !important;
            }
            
            .wizard-step-indicator {
                min-width: 40px;
            }
            
            .wizard-header h1 {
                font-size: 1.1em;
            }
            
            .wizard-step h2 {
                font-size: 1.1em;
            }
            
            /* Icon selector - keep 6 columns, just smaller icons */
            .icon-option {
                font-size: 1.2em !important;
            }
            
            /* Theme presets - still 2 columns but smaller */
            .preset-themes {
                gap: 8px !important;
            }
            
            .theme-preset {
                padding: 10px 6px !important;
            }
            
            .theme-preset span[style*="font-size: 2em"] {
                font-size: 1.3em !important;
            }
            
            .theme-preset div[style*="font-weight: 600"] {
                font-size: 0.75em !important;
            }
        }

        /* Collapsible Section */
        .toggle-features {
            text-align: center;
            margin: 20px 0;
            transition: margin 0.8s ease;
        }

        .toggle-btn {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 15px 30px;
            cursor: pointer;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .toggle-arrow {
            transition: transform 0.3s ease;
            font-size: 1.2em;
        }

        .toggle-arrow.expanded {
            transform: rotate(180deg);
        }

        .advanced-feature {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.8s ease, opacity 0.5s ease, margin-bottom 0.8s ease;
            margin-bottom: 0;
        }

        .advanced-feature.show {
            max-height: 2000px;
            opacity: 1;
            margin-bottom: 20px;
        }

        .advanced-features {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
            background: transparent;
            width: 100%;
            padding: 0;
            margin: 0 -20px;
        }

        .advanced-features.expanded {
            max-height: 3000px;
            transition: max-height 0.5s ease-in;
            padding: 0 20px 20px 20px;
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <!-- Setup Wizard -->
    <div id="setupWizard" class="setup-wizard">
        <div class="wizard-container">
            <!-- Wizard Header -->
            <div class="wizard-header">
                <h1> Dashboard Setup Wizard</h1>
                <p>Let's configure your PiKVM Control Dashboard</p>
            </div>

            <!-- Progress Indicator -->
            <div class="wizard-progress">
                <div class="wizard-step-indicator active" data-step="1" onclick="goToWizardStep(1)" style="cursor: pointer;">
                    <span class="wizard-step-number">1</span>
                    <span class="wizard-step-label">Hardware</span>
                </div>
                <div class="wizard-step-indicator" data-step="2" onclick="goToWizardStep(2)" style="cursor: pointer;">
                    <span class="wizard-step-number">2</span>
                    <span class="wizard-step-label">PCs</span>
                </div>
                <div class="wizard-step-indicator" data-step="3" onclick="goToWizardStep(3)" style="cursor: pointer;">
                    <span class="wizard-step-number">3</span>
                    <span class="wizard-step-label">Appearance</span>
                </div>
                <div class="wizard-step-indicator" data-step="4" onclick="goToWizardStep(4)" style="cursor: pointer;">
                    <span class="wizard-step-number">4</span>
                    <span class="wizard-step-label">Features</span>
                </div>
                <div class="wizard-step-indicator" data-step="5" onclick="goToWizardStep(5)" style="cursor: pointer;">
                    <span class="wizard-step-number">5</span>
                    <span class="wizard-step-label">Advanced</span>
                </div>
                <div class="wizard-step-indicator" data-step="6" onclick="goToWizardStep(6)" style="cursor: pointer;">
                    <span class="wizard-step-number">6</span>
                    <span class="wizard-step-label">Review</span>
                </div>
            </div>

            <!-- Wizard Body -->
            <div class="wizard-body" id="wizardBody">
                <!-- Steps will be added here by JavaScript -->
            </div>

            <!-- Wizard Footer -->
            <div class="wizard-footer">
                <button class="wizard-btn wizard-btn-secondary" id="wizardPrev" onclick="wizardPrevStep()" disabled> Previous</button>
                <div>
                    <button class="wizard-btn wizard-btn-secondary" onclick="skipWizard()" id="wizardSkip" style="margin-right: 10px;">Skip Setup</button>
                    <button class="wizard-btn wizard-btn-primary" id="wizardSave" onclick="saveSettings()" style="display: none; margin-right: 10px;"> Save Settings</button>
                    <button class="wizard-btn wizard-btn-primary" id="wizardNext" onclick="wizardNextStep()">Next </button>
                    <button class="wizard-btn wizard-btn-primary" id="wizardFinish" onclick="finishWizard()" style="display: none;">Finish Setup </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Dialog -->
    <div id="confirmDialog" class="confirm-dialog">
        <div class="confirm-box">
            <div class="confirm-header">
                <h2 id="confirmTitle">Confirm Action</h2>
            </div>
            <div class="confirm-body" id="confirmMessage">
                Are you sure?
            </div>
            <div class="confirm-buttons">
                <button class="confirm-btn confirm-btn-no" onclick="closeConfirmDialog(false)">No</button>
                <button class="confirm-btn confirm-btn-yes" onclick="closeConfirmDialog(true)">Yes</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>
    
    <!-- Shutdown/Reset Modal -->
    <div id="shutdownModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle"> Power Control</div>
            <div class="modal-text" id="modalText">Choose shutdown method:</div>
            <div class="modal-buttons" id="modalButtons">
                <!-- Buttons will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Generic Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="confirmModalTitle"> Confirm Action</div>
            <div class="modal-text" id="confirmModalText">Are you sure?</div>
            <div class="modal-buttons">
                <button class="btn-modal btn-modal-cancel" onclick="closeConfirmModal(false)">Cancel</button>
                <button class="btn-modal btn-modal-confirm" onclick="closeConfirmModal(true)">Confirm</button>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="aboutModal" class="modal">
        <div class="modal-content" style="max-width: 450px; text-align: center;">
            <div class="modal-title" style="font-size: 1.5em; margin-bottom: 20px;"> About PiKVM Dashboard</div>
            
            <div style="margin-bottom: 25px;">
                <p style="color: var(--text-secondary); font-size: 0.95em; line-height: 1.6;">
                    A custom dashboard for managing multiple PCs through PiKVM with scheduled actions, idle shutdown, and more.
                </p>
            </div>
            
            <!-- GitHub -->
            <div style="margin-bottom: 20px;">
                <a href="https://github.com/DanCue44" target="_blank" rel="noopener noreferrer" 
                   style="display: inline-flex; align-items: center; gap: 10px; padding: 12px 24px; background: #6e7681; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s ease;">
                    <svg height="24" width="24" viewBox="0 0 16 16" fill="white">
                        <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                    </svg>
                    <span>Follow Me on GitHub</span>
                </a>
            </div>
            
            <!-- Patreon -->
            <div style="background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(255, 140, 0, 0.1)); border: 1px solid rgba(255, 140, 0, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <div style="font-size: 1.8em; margin-bottom: 10px;"></div>
                <h3 style="color: #ff8c00; margin: 0 0 10px 0; font-size: 1.1em;">Support This Project</h3>
                <p style="color: var(--text-secondary); font-size: 0.9em; line-height: 1.6; margin-bottom: 15px;">
                    If this dashboard has made managing your PiKVM setup easier, consider supporting its continued development. Your contribution helps fuel new features, bug fixes, and keeps the project alive. Every bit of support means the world!
                </p>
                <a href="https://www.patreon.com/c/DanCue44" target="_blank" rel="noopener noreferrer"
                   style="display: inline-flex; align-items: center; gap: 10px; padding: 12px 24px; background: linear-gradient(135deg, #ff6b35, #ff8c00); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s ease;">
                    <span style="font-size: 1.2em;"></span>
                    <span>Support on Patreon</span>
                </a>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="btn-modal btn-modal-cancel" onclick="closeAboutModal()" style="min-width: 120px;">Close</button>
            </div>
        </div>
    </div>

    <!-- Add Follow-up Action Modal -->
    <div id="followUpModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-title"> Add Follow-up Action</div>
            <div style="margin: 20px 0;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--text-secondary);">Delay Before Action</label>
                    <div style="display: grid; grid-template-columns: 1fr 120px; gap: 8px;">
                        <input type="number" class="schedule-input idle-minutes-input" id="followup-delay" min="1" value="60" style="margin: 0;">
                        <select class="schedule-input" id="followup-delay-unit" style="margin: 0;">
                            <option value="seconds">Seconds</option>
                            <option value="minutes" selected>Minutes</option>
                            <option value="hours">Hours</option>
                            <option value="days">Days</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--text-secondary);">Action Type</label>
                    <select class="schedule-input" id="followup-action-type" onchange="toggleFollowUpActionType()" style="margin: 0;">
                        <option value="power">Power Action</option>
                        <option value="keyboard">Keyboard Shortcut</option>
                    </select>
                </div>
                
                <!-- Power Action -->
                <div id="followup-power-options">
                    <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--text-secondary);">Action</label>
                    <select class="schedule-input" id="followup-power-action" style="margin: 0;">
                        <option value="on">Power On</option>
                        <option value="off">Power Off</option>
                        <option value="reset">Reset</option>
                    </select>
                </div>
                
                <!-- Keyboard Action -->
                <div id="followup-keyboard-options" style="display: none;">
                    <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--text-secondary);">Keyboard Shortcut</label>
                    <select class="schedule-input" id="followup-keyboard-shortcut" style="margin: 0;">
                        <option value="ctrl-alt-del">Ctrl+Alt+Del</option>
                        <option value="ctrl-alt-esc">Ctrl+Alt+Esc</option>
                        <option value="alt-f4">Alt+F4</option>
                        <option value="win">Windows Key</option>
                        <option value="win-r">Win+R</option>
                        <option value="win-l">Win+L (Lock)</option>
                    </select>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn-modal btn-modal-cancel" onclick="closeFollowUpModal()">Cancel</button>
                <button class="btn-modal btn-modal-confirm" onclick="addFollowUpAction()">Add Follow-up</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-grid">
                <a href="/" class="header-logo-link">
                    <img src="/logo.png" alt="PiKVM" class="header-logo">
                </a>
                <h1 class="header-title">Control Dashboard</h1>
                <div class="header-menu">
                    <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleMenu()" title="Menu">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 12H21M3 6H21M3 18H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="pc-grid">
            <div class="pc-cards">
                <!-- PC cards will be dynamically generated here -->
            </div>
        </div>

        <!-- Toggle Advanced Features Button (hidden - now in hamburger menu) -->
        <div class="toggle-features" style="display: none;">
            <button class="toggle-btn" onclick="toggleAdvancedFeatures()">
                <span id="toggle-text">Show Advanced Features</span>
                <span class="toggle-arrow" id="toggle-arrow"></span>
            </button>
        </div>

        <!-- NEW: Keyboard Shortcuts Section -->
        <div class="shortcuts-section advanced-feature" id="shortcuts-section">
            <div class="shortcuts-title"> Keyboard Shortcuts</div>
            <select class="pc-selector" id="shortcut-pc-selector">
                <option value="">Select PC first...</option>
                <option value="0">MediaServer</option>
                <option value="1">GamingPC</option>
            </select>
            <div class="shortcuts-grid">
                <button class="shortcut-btn" onclick="sendShortcut('ctrl-alt-del')" disabled id="shortcut-cad">Ctrl+Alt+Del</button>
                <button class="shortcut-btn" onclick="sendShortcut('ctrl-alt-esc')" disabled id="shortcut-cae">Ctrl+Alt+Esc</button>
                <button class="shortcut-btn" onclick="sendShortcut('alt-f4')" disabled id="shortcut-af4">Alt+F4</button>
                <button class="shortcut-btn" onclick="sendShortcut('win')" disabled id="shortcut-win">Windows Key</button>
                <button class="shortcut-btn" onclick="sendShortcut('win-r')" disabled id="shortcut-winr">Win+R</button>
                <button class="shortcut-btn" onclick="sendShortcut('win-l')" disabled id="shortcut-winl">Win+L (Lock)</button>
            </div>
        </div>

        <!-- NEW: Scheduled Actions Section -->
        <div class="scheduled-section advanced-feature" id="scheduled-section">
            <div class="scheduled-title"> Scheduled Actions</div>
            <div class="important-banner" style="border-left: 3px solid #ff9800; padding: 12px; margin-bottom: 16px; border-radius: 4px; font-size: 13px;">
                 <strong>Important:</strong> PiKVM must be running continuously for scheduled actions to execute. If PiKVM is powered off when an action is scheduled to trigger, that action will be missed.
            </div>
            <div class="schedule-form">
                <!-- Three dropdowns in one row on desktop, stack on mobile - full width -->
                <div id="schedule-dropdowns-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px; width: 100%;">
                    <select class="schedule-input" id="schedule-pc" style="margin: 0; width: 100%;">
                        <option value="0">MediaServer</option>
                        <option value="1">GamingPC</option>
                    </select>
                    <select class="schedule-input" id="schedule-action-type" onchange="toggleActionOptions()" style="margin: 0; width: 100%;">
                        <option value="power">Power Action</option>
                        <option value="keyboard">Keyboard Shortcut</option>
                    </select>
                    <!-- This div will contain either power or keyboard options -->
                    <div id="action-dropdown-container" style="width: 100%;">
                        <!-- Power Action Options -->
                        <select class="schedule-input" id="schedule-action" style="margin: 0; width: 100%;">
                            <option value="on">Power On</option>
                            <option value="off">Power Off</option>
                            <option value="reset">Reset</option>
                        </select>
                        
                        <!-- Keyboard Shortcut Options (hidden by default) -->
                        <select class="schedule-input" id="schedule-keyboard-shortcut" style="display: none; margin: 0; width: 100%;">
                            <option value="ctrl-alt-del">Ctrl+Alt+Del</option>
                            <option value="ctrl-alt-esc">Ctrl+Alt+Esc</option>
                            <option value="alt-f4">Alt+F4</option>
                            <option value="win">Windows Key</option>
                            <option value="win-r">Win+R</option>
                            <option value="win-l">Win+L (Lock)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Date/Time and Condition on same row -->
                <div id="datetime-condition-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--text-secondary);"> Date & Time</label>
                        <input type="datetime-local" class="schedule-input" id="schedule-time" style="margin: 0; width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--text-secondary);"> Condition</label>
                        <select class="schedule-input" id="schedule-condition" style="margin: 0; width: 100%;">
                            <option value="always">Always execute</option>
                            <option value="if_off">Only if PC is OFF</option>
                            <option value="if_on">Only if PC is ON</option>
                            <option value="smart" selected>Smart (skip if already in desired state)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Recurring Options -->
                <div style="margin-bottom: 12px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="schedule-recurring" onchange="toggleRecurringOptions()" style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-size: 14px; color: var(--text-primary);">Recurring Schedule</span>
                    </label>
                </div>
                
                <div id="recurring-options" class="recurring-options-box" style="display: none; margin-bottom: 12px; padding: 12px; border-radius: 6px;">
                    <div style="display: grid; grid-template-columns: 200px 1fr; gap: 16px; align-items: start;">
                        <!-- Left column: Frequency -->
                        <div>
                            <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--text-secondary);">Frequency</label>
                            <select class="schedule-input" id="schedule-frequency" onchange="toggleDayOfWeekSelector()" style="margin: 0;">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="biweekly">Bi-weekly</option>
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                                <option value="annually">Annually</option>
                            </select>
                        </div>
                        
                        <!-- Right column: Days of Week -->
                        <div id="day-of-week-selector" style="display: none;">
                            <label style="display: block; margin-bottom: 8px; font-size: 13px; color: var(--text-secondary);">Days of Week</label>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px;">
                                <label class="day-checkbox-label">
                                    <input type="checkbox" class="schedule-day-checkbox" value="0">
                                    <span>Monday</span>
                                </label>
                                <label class="day-checkbox-label">
                                    <input type="checkbox" class="schedule-day-checkbox" value="1">
                                    <span>Tuesday</span>
                                </label>
                                <label class="day-checkbox-label">
                                    <input type="checkbox" class="schedule-day-checkbox" value="2">
                                    <span>Wednesday</span>
                                </label>
                                <label class="day-checkbox-label">
                                    <input type="checkbox" class="schedule-day-checkbox" value="3">
                                    <span>Thursday</span>
                                </label>
                                <label class="day-checkbox-label">
                                    <input type="checkbox" class="schedule-day-checkbox" value="4">
                                    <span>Friday</span>
                                </label>
                                <label class="day-checkbox-label">
                                    <input type="checkbox" class="schedule-day-checkbox" value="5">
                                    <span>Saturday</span>
                                </label>
                                <label class="day-checkbox-label">
                                    <input type="checkbox" class="schedule-day-checkbox" value="6">
                                    <span>Sunday</span>
                                </label>
                            </div>
                            <small style="color: var(--text-secondary); display: block; margin-top: 6px;">
                                 Select multiple days for the schedule to repeat on
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Full-width button at bottom -->
                <button class="btn-save" onclick="addScheduledAction()" style="width: 100%; margin: 0; padding: 12px; font-size: 15px;">
                     Add Schedule
                </button>
            </div>
            <div id="schedule-empty-message" style="text-align: center; color: var(--theme-text-color, var(--text-primary)); padding: 20px 0;">No scheduled actions</div>
            
            <!-- View Toggle -->
            <div style="display: flex; justify-content: center; margin-bottom: 16px;">
                <div style="display: inline-flex; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                    <button id="view-list-btn" onclick="setScheduleView('list')" style="padding: 8px 20px; border: none; background: #ff8c00; color: white; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; min-width: 110px;">
                         List
                    </button>
                    <button id="view-calendar-btn" onclick="setScheduleView('calendar')" style="padding: 8px 20px; border: none; background: transparent; color: var(--theme-text-color, var(--text-primary)); cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; min-width: 110px;">
                         Calendar
                    </button>
                </div>
            </div>
            
            <!-- Bulk Actions Bar -->
            <div id="bulk-actions-bar" style="display: none; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 15px; margin-bottom: 10px; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span id="selected-count" style="font-weight: 600; color: var(--text-primary);">0 selected</span>
                    <button onclick="selectAllSchedules()" style="background: none; border: none; color: var(--accent-color); cursor: pointer; font-size: 13px; padding: 4px 8px;">Select All</button>
                    <button onclick="deselectAllSchedules()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 13px; padding: 4px 8px;">Deselect All</button>
                </div>
                <button onclick="deleteSelectedSchedules()" style="background: #dc3545; color: white; border: none; border-radius: 6px; padding: 8px 16px; cursor: pointer; font-size: 13px; font-weight: 600;">
                     Delete Selected
                </button>
            </div>
            
            <!-- List View -->
            <div id="schedule-list-view">
                <div class="schedule-list" id="schedule-list"></div>
            </div>
            
            <!-- Calendar View -->
            <div id="schedule-calendar-view" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <button onclick="changeCalendarMonth(-1)" style="background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 16px;"></button>
                    <h3 id="calendar-month-label" style="margin: 0; color: var(--text-primary); font-size: 18px;"></h3>
                    <button onclick="changeCalendarMonth(1)" style="background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 16px;"></button>
                </div>
                <div id="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;"></div>
                <div id="calendar-day-details" style="margin-top: 16px; display: none;"></div>
            </div>
        </div>

        <!-- NEW: Idle Shutdown Section -->
        <div class="idle-section advanced-feature" id="idle-section">
            <div class="idle-title"> Idle Auto-Shutdown (minutes)</div>
            <div class="idle-config">
                <!-- MediaServer Idle Config -->
                <div class="idle-card">
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
                        <div style="display: flex; flex-direction: column; gap: 2px;">
                            <div class="idle-card-title" style="margin: 0;">MediaServer</div>
                            <div class="idle-status" id="idle-status-0" style="margin: 0; font-size: 0.85em;">Disabled</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="number" class="schedule-input idle-minutes-input" id="idle-minutes-0" placeholder="Minutes" min="5" max="1440" value="30" style="margin: 0; width: 80px; height: 36px; padding: 8px; text-align: center;">
                            <label class="toggle-switch" style="margin: 0;">
                                <input type="checkbox" id="idle-enabled-0" onchange="toggleIdleShutdown(0)">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- GamingPC Idle Config -->
                <div class="idle-card">
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
                        <div style="display: flex; flex-direction: column; gap: 2px;">
                            <div class="idle-card-title" style="margin: 0;">GamingPC</div>
                            <div class="idle-status" id="idle-status-1" style="margin: 0; font-size: 0.85em;">Disabled</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="number" class="schedule-input idle-minutes-input" id="idle-minutes-1" placeholder="Minutes" min="5" max="1440" value="30" style="margin: 0; width: 80px; height: 36px; padding: 8px; text-align: center;">
                            <label class="toggle-switch" style="margin: 0;">
                                <input type="checkbox" id="idle-enabled-1" onchange="toggleIdleShutdown(1)">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Log (moved to advanced section) -->
        <div class="action-log advanced-feature" id="action-log-section">
            <div class="action-log-title"> Recent Actions</div>
            <div class="action-log-items" id="actionLog">
                <div style="text-align: center; color: var(--text-secondary); padding: 20px;">No recent actions</div>
            </div>
        </div>

        <!-- Maintenance Section -->
        <div class="config-section advanced-feature" id="config-section">
            <div class="config-title"> Maintenance</div>
            
            <!-- Credentials Status -->
            <div style="background: rgba(76, 175, 80, 0.1); border: 1px solid rgba(76, 175, 80, 0.3); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2em;"></span>
                    <div>
                        <div style="font-weight: 600; color: #4CAF50;">Credentials Configured</div>
                        <div style="font-size: 0.85em; color: var(--text-secondary);">Login settings were saved during installation</div>
                    </div>
                </div>
            </div>
            
            <!-- Expandable Credential Editor -->
            <details style="margin-bottom: 16px;">
                <summary style="cursor: pointer; padding: 10px; background: var(--bg-tertiary); border-radius: 6px; font-weight: 500; user-select: none;">
                     Change Login Credentials (Optional)
                </summary>
                <div style="padding: 16px 0 0 0;">
                    <input type="text" class="config-input" id="pikvm-url" placeholder="PiKVM URL (leave blank if hosted on PiKVM)" value="" autocomplete="off">
                    <input type="text" class="config-input" id="pikvm-username" placeholder="Username" value="admin" autocomplete="off">
                    <input type="password" class="config-input" id="pikvm-password" placeholder="Password" value="" autocomplete="new-password">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn-save" onclick="saveConfig()" style="flex: 1; min-width: 120px;"> Update</button>
                        <button class="btn-clear" onclick="clearConfig()" style="flex: 1; min-width: 120px;"> Clear</button>
                    </div>
                </div>
            </details>
            
            <hr style="border: none; border-top: 1px solid var(--border-color); margin: 16px 0;">
            
            <!-- Icon Cleanup -->
            <div style="text-align: center;">
                <p style="color: var(--text-secondary); font-size: 0.9em; margin-bottom: 10px;">
                    Remove unused uploaded icons from disk
                </p>
                <button class="btn-clear" onclick="cleanupUnusedIcons()" style="max-width: 300px; margin: 0 auto;">
                     Clean Up Unused Icons
                </button>
            </div>
        </div>

        <!-- Show Config Button (visible when config is hidden) -->
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn-save" id="show-config-btn" style="max-width: 300px; margin: 0 auto; display: none;" onclick="showConfigSection()"> Show Maintenance</button>
        </div>

    </div>

    <!-- Hamburger Menu Overlay -->
    <div id="menuOverlay" class="menu-overlay" onclick="closeMenuOnOverlayClick(event)">
        <div class="menu-content" onclick="event.stopPropagation()">
            <div class="menu-header">
                <h2>Menu</h2>
                <button class="menu-close" onclick="toggleMenu()"></button>
            </div>
            <div class="menu-items">
                <div class="menu-item-with-toggle">
                    <button class="menu-item" onclick="document.getElementById('menuThemeToggle').click();">
                        <span id="menuThemeIcon"></span>
                        <span id="menuThemeText">Light Mode</span>
                    </button>
                    <label class="menu-toggle">
                        <input type="checkbox" id="menuThemeToggle" onchange="toggleTheme(); updateMenuThemeText();">
                        <span class="menu-toggle-slider"></span>
                    </label>
                </div>
                <div class="menu-item-with-toggle">
                    <button class="menu-item" onclick="document.getElementById('menuSoundToggle').click();">
                        <span id="menuSoundIcon"></span>
                        <span id="menuSoundText">Sound On</span>
                    </button>
                    <label class="menu-toggle">
                        <input type="checkbox" id="menuSoundToggle" onchange="toggleSound(); updateMenuSoundText();">
                        <span class="menu-toggle-slider"></span>
                    </label>
                </div>
                <div class="menu-item-with-toggle">
                    <button class="menu-item" onclick="document.getElementById('menuNotifyToggle').click();">
                        <span id="menuNotifyIcon"></span>
                        <span id="menuNotifyText">Notifications Off</span>
                    </button>
                    <label class="menu-toggle">
                        <input type="checkbox" id="menuNotifyToggle" onchange="toggleNotificationsFromMenu();">
                        <span class="menu-toggle-slider"></span>
                    </label>
                </div>
                <div class="menu-item-with-toggle">
                    <button class="menu-item" onclick="document.getElementById('menuAdvancedToggle').click();">
                        <span></span>
                        <span id="menuAdvancedText">Show Advanced</span>
                    </button>
                    <label class="menu-toggle">
                        <input type="checkbox" id="menuAdvancedToggle" onchange="toggleAdvancedFeatures(); updateMenuAdvancedText();">
                        <span class="menu-toggle-slider"></span>
                    </label>
                </div>
                <div class="menu-divider"></div>
                <button class="menu-item" onclick="openSettings(); toggleMenu();">
                    <span></span>
                    <span>Settings</span>
                </button>
                <div class="menu-divider"></div>
                <button class="menu-item" onclick="navigateToKVM()">
                    <span></span>
                    <span>KVM</span>
                </button>
                <button class="menu-item" onclick="navigateToTerminal()">
                    <span></span>
                    <span>Terminal</span>
                </button>
                <button class="menu-item" onclick="navigateToVNC()">
                    <span></span>
                    <span>VNC</span>
                </button>
                <div class="menu-divider"></div>
                <button class="menu-item" onclick="showAboutModal(); toggleMenu();">
                    <span></span>
                    <span>About</span>
                </button>
                <button class="menu-item menu-item-danger" onclick="logoutPiKVM()">
                    <span></span>
                    <span>Logout</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============ DEBUG LOGGING ============
        console.log('PiKVM Dashboard: Script loading...');
        
        // ============ WIZARD STATE ============
        let wizardCurrentStep = 1;
        let wizardConfig = {};
        let isSettingsMode = false; // Track if editing existing config vs first-time setup
        const ICON_OPTIONS = {
            'laptop': '',
            'desktop': '',
            'gaming': '',
            'server': '',
            'workstation': '',
            'storage': '',
            'office': '',
            'media': '',
            'network': '',
            'lab': '',
            'creative': ''
        };
        
        // Custom images stored in /usr/share/kvmd/web/dashboard-images/
        // Can be used by setting icon to the image filename, e.g. "steamdeck.png"
        let CUSTOM_IMAGES = [];
        
        // Load available custom images from the images directory
        async function loadCustomImages() {
            try {
                const response = await fetch('/dashboard-images/');
                if (response.ok) {
                    const html = await response.text();
                    // Extract image filenames from directory listing
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const links = Array.from(doc.querySelectorAll('a[href]'));
                    CUSTOM_IMAGES = links
                        .map(a => a.getAttribute('href'))
                        .filter(href => /\.(png|jpg|jpeg|gif|svg|webp)$/i.test(href))
                        .filter(href => !href.startsWith('/') && href !== '../');
                }
            } catch (error) {
                console.log('No custom images directory or error loading images:', error);
            }
        }
        
        const THEME_PRESETS = {
            'default': {
                emoji: '',
                light: {
                    headerColor: '#1a1a1a',
                    cardTitle: '#1a1a1a',
                    cardBg: '#ffffff',
                    inputBg: '#c5ccd3',
                    buttonBg: '#757575',
                    siteBg: '#f0f4f8',
                    textColor: '#2c3e50'
                },
                dark: {
                    headerColor: '#ffffff',
                    cardTitle: '#ffffff',
                    cardBg: '#2a2a2a',
                    inputBg: '#1e1e1e',
                    buttonBg: '#505050',
                    siteBg: '#1a1a1a',
                    textColor: '#e8e8e8'
                }
            },
            'ocean': {
                emoji: '',
                light: {
                    headerColor: '#0d47a1',
                    cardTitle: '#0d47a1',
                    cardBg: '#ffffff',
                    inputBg: '#90caf9',
                    buttonBg: '#1976d2',
                    siteBg: '#e1f5fe',
                    textColor: '#0d47a1'
                },
                dark: {
                    headerColor: '#4fc3f7',
                    cardTitle: '#4fc3f7',
                    cardBg: '#102a43',
                    inputBg: '#0d1f30',
                    buttonBg: '#1565c0',
                    siteBg: '#0a1929',
                    textColor: '#b3e5fc'
                }
            },
            'sunset': {
                emoji: '',
                light: {
                    headerColor: '#c2185b',
                    cardTitle: '#c2185b',
                    cardBg: '#ffffff',
                    inputBg: '#f48fb1',
                    buttonBg: '#e91e63',
                    siteBg: '#fce4ec',
                    textColor: '#880e4f'
                },
                dark: {
                    headerColor: '#ff8a65',
                    cardTitle: '#ff8a65',
                    cardBg: '#2d1f2f',
                    inputBg: '#241820',
                    buttonBg: '#d84315',
                    siteBg: '#1a1018',
                    textColor: '#ffccbc'
                }
            },
            'forest': {
                emoji: '',
                light: {
                    headerColor: '#2e7d32',
                    cardTitle: '#2e7d32',
                    cardBg: '#ffffff',
                    inputBg: '#a5d6a7',
                    buttonBg: '#43a047',
                    siteBg: '#e8f5e9',
                    textColor: '#1b5e20'
                },
                dark: {
                    headerColor: '#81c784',
                    cardTitle: '#81c784',
                    cardBg: '#1a2e1a',
                    inputBg: '#122312',
                    buttonBg: '#388e3c',
                    siteBg: '#0d1a0d',
                    textColor: '#a5d6a7'
                }
            },
            'fire': {
                emoji: '',
                light: {
                    headerColor: '#c62828',
                    cardTitle: '#c62828',
                    cardBg: '#ffffff',
                    inputBg: '#ef9a9a',
                    buttonBg: '#e53935',
                    siteBg: '#ffebee',
                    textColor: '#b71c1c'
                },
                dark: {
                    headerColor: '#ff7043',
                    cardTitle: '#ff7043',
                    cardBg: '#2d1a1a',
                    inputBg: '#241212',
                    buttonBg: '#d32f2f',
                    siteBg: '#1a0f0f',
                    textColor: '#ffab91'
                }
            },
            'purple': {
                emoji: '',
                light: {
                    headerColor: '#6a1b9a',
                    cardTitle: '#6a1b9a',
                    cardBg: '#ffffff',
                    inputBg: '#ce93d8',
                    buttonBg: '#8e24aa',
                    siteBg: '#f3e5f5',
                    textColor: '#4a148c'
                },
                dark: {
                    headerColor: '#ba68c8',
                    cardTitle: '#ba68c8',
                    cardBg: '#231a2e',
                    inputBg: '#1a1222',
                    buttonBg: '#7b1fa2',
                    siteBg: '#150d1a',
                    textColor: '#ce93d8'
                }
            },
            'midnight': {
                emoji: '',
                light: {
                    headerColor: '#263238',
                    cardTitle: '#37474f',
                    cardBg: '#ffffff',
                    inputBg: '#b0bec5',
                    buttonBg: '#546e7a',
                    siteBg: '#eceff1',
                    textColor: '#263238'
                },
                dark: {
                    headerColor: '#b0bec5',
                    cardTitle: '#b0bec5',
                    cardBg: '#1e272e',
                    inputBg: '#151c22',
                    buttonBg: '#455a64',
                    siteBg: '#0f1318',
                    textColor: '#cfd8dc'
                }
            },
            'custom': {
                emoji: '',
                light: {
                    headerColor: '#1a1a1a',
                    cardTitle: '#1a1a1a',
                    cardBg: '#ffffff',
                    inputBg: '#c5ccd3',
                    buttonBg: '#757575',
                    siteBg: '#f5f5f5',
                    textColor: '#333333'
                },
                dark: {
                    headerColor: '#ffffff',
                    cardTitle: '#ffffff',
                    cardBg: '#2a2a2a',
                    inputBg: '#1e1e1e',
                    buttonBg: '#505050',
                    siteBg: '#1a1a1a',
                    textColor: '#e8e8e8'
                }
            }
        };
        
        // ============ EXISTING DASHBOARD CODE ============
        let currentPort = null;
        let currentAction = null;
        let statusCheckInterval = null;
        let countdownInterval = null;
        let nextCheckTime = null;
        let isProcessingCommand = false;
        let processingPorts = {};
        let actionLog = [];
        let lastSeenActionTime = null; // Track last seen action for notifications
        let notificationsEnabled = localStorage.getItem('notifications_enabled') === 'true';
        let soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
        let theme = localStorage.getItem('theme') || 'dark';
        let scheduledActions = [];
        let selectedSchedules = new Set(); // Track selected schedules for bulk operations
        let scheduleCheckInterval = null;
        let idleTimers = {};
        let lastActivityTime = {};
        let advancedFeaturesExpanded = localStorage.getItem('advancedFeaturesExpanded') === 'true';
        
        // API Configuration
        const API_BASE = '/api/dashboard';  // Backend API base URL
        
        // ============ AUTHENTICATION ============
        
        const EMBEDDED_USERNAME = 'PIKVM_USERNAME_PLACEHOLDER';
        const EMBEDDED_PASSWORD = 'PIKVM_PASSWORD_PLACEHOLDER';
        
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.ok === true;
                }
                return false;
            } catch (error) {
                console.error('Auth check failed:', error);
                return false;
            }
        }
        
        async function autoLogin() {
            try {
                const formData = new FormData();
                formData.append('user', EMBEDDED_USERNAME);
                formData.append('passwd', EMBEDDED_PASSWORD);
                formData.append('expire', '0');
                
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.ok === true;
                }
                return false;
            } catch (error) {
                console.error('Auto-login failed:', error);
                return false;
            }
        }
        
        async function initDashboard() {
            // Load configuration
            const config = await apiRequest('/config');
            
            if (!config || config.firstRun) {
                // Should not happen, but safety check
                await showSetupWizard();
                return;
            }
            
            // Store config globally for other functions to use
            window.dashboardConfig = config;
            
            // Build dashboard from config
            await buildDynamicDashboard(config);
            
            // Load user preferences (separate from config)
            await loadPreferences();
            await loadActionLog();
            await loadScheduledActions();
            
            // Immediate status check (with tiny delay to ensure DOM is ready)
            setTimeout(() => {
                console.log('Running immediate status check...');
                checkAllStatus();
                updateUptime();
            }, 100);
            
            // Start regular monitoring intervals
            startStatusChecking();
            startScheduleChecking();
            startIdleMonitoring();
        }
        
        async function buildDynamicDashboard(config) {
            // Apply appearance
            applyAppearance(config.appearance);
            
            // Update theme toggle button to reflect current mode
            updateThemeButton(config.appearance.mode);
            
            // Build PC cards
            buildPCCards(config);
            
            // Show/hide features
            toggleFeatureVisibility(config.features);
            
            // Apply custom CSS if provided
            if (config.advanced.customCSS) {
                applyCustomCSS(config.advanced.customCSS);
            }
        }
        
        function applyAppearance(appearance) {
            const themeName = appearance.theme || 'default';
            const mode = appearance.mode || 'dark';
            
            // Load custom colors if they exist
            if (themeName === 'custom' && appearance.customColors) {
                THEME_PRESETS.custom.light = appearance.customColors.light;
                THEME_PRESETS.custom.dark = appearance.customColors.dark;
            }
            
            const themeColors = THEME_PRESETS[themeName][mode];
            
            // Apply theme colors as CSS variables
            document.documentElement.style.setProperty('--header-color', themeColors.headerColor || themeColors.cardTitle);
            document.documentElement.style.setProperty('--card-title-color', themeColors.cardTitle);
            document.documentElement.style.setProperty('--card-bg-color', themeColors.cardBg);
            document.documentElement.style.setProperty('--input-bg-color', themeColors.inputBg);
            document.documentElement.style.setProperty('--button-bg-color', themeColors.buttonBg);
            document.documentElement.style.setProperty('--site-bg-color', themeColors.siteBg);
            document.documentElement.style.setProperty('--main-text-color', themeColors.textColor);
            document.documentElement.style.setProperty('--theme-text-color', themeColors.textColor);
            
            // Override text and border CSS variables so inline var() styles pick up theme colors
            document.documentElement.style.setProperty('--text-primary', themeColors.textColor);
            document.documentElement.style.setProperty('--text-secondary', themeColors.textColor);
            document.documentElement.style.setProperty('--bg-tertiary', themeColors.inputBg);
            document.documentElement.style.setProperty('--bg-secondary', themeColors.cardBg);
            
            // Compute a visible border color (darken inputBg by blending toward textColor)
            const computeBorder = (text, bg) => {
                const t = parseInt(text.slice(1), 16), b = parseInt(bg.slice(1), 16);
                const r = Math.round(((t>>16)&0xFF)*0.35 + ((b>>16)&0xFF)*0.65);
                const g = Math.round(((t>>8)&0xFF)*0.35 + ((b>>8)&0xFF)*0.65);
                const bl = Math.round((t&0xFF)*0.35 + (b&0xFF)*0.65);
                return `#${((r<<16)|(g<<8)|bl).toString(16).padStart(6,'0')}`;
            };
            document.documentElement.style.setProperty('--border-color', computeBorder(themeColors.textColor, themeColors.inputBg));
            
            // Apply background
            if (appearance.backgroundImage) {
                document.body.style.backgroundImage = `url(${appearance.backgroundImage})`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundPosition = 'center';
                document.body.style.backgroundAttachment = 'fixed';
            } else {
                document.body.style.backgroundImage = 'none';
                document.body.style.background = themeColors.siteBg;
            }
            
            // Apply logo
            const logoImg = document.querySelector('.header-logo');
            if (logoImg && appearance.logo) {
                logoImg.src = appearance.logo;
            }
            
            // Apply title
            const titleEl = document.querySelector('.header-title');
            if (titleEl && appearance.dashboardTitle) {
                titleEl.textContent = appearance.dashboardTitle;
            }
            
            // Apply colors to elements
            const style = document.createElement('style');
            style.id = 'theme-colors';
            style.textContent = `
                /* Header styling */
                .header-title {
                    color: ${themeColors.headerColor || themeColors.cardTitle} !important;
                }
                
                /* Hamburger menu button - use inputBg as background, headerColor for icon */
                .hamburger-btn {
                    background: ${themeColors.inputBg} !important;
                    border-color: ${themeColors.cardBg} !important;
                    color: ${themeColors.headerColor || themeColors.cardTitle} !important;
                }
                .hamburger-btn svg path {
                    stroke: ${themeColors.headerColor || themeColors.cardTitle} !important;
                }
                
                /* Card backgrounds */
                .pc-card,
                .action-log,
                .scheduled-section,
                .idle-section,
                .shortcuts-section,
                .config-section {
                    background: ${themeColors.cardBg} !important;
                }
                
                /* Inner element backgrounds (inputs, status boxes, etc.) */
                .status-indicator,
                .status-indicators,
                .pc-selector,
                .schedule-input,
                .config-input,
                .idle-card,
                .shortcut-btn,
                .action-log-item,
                .schedule-item,
                .schedule-list,
                .day-checkbox-label,
                #recurring-options,
                .followup-item {
                    background: ${themeColors.inputBg} !important;
                }
                
                /* Card titles */
                .pc-name span:first-child,
                .action-log-title,
                .scheduled-title,
                .idle-title,
                .shortcuts-title,
                .config-title {
                    color: ${themeColors.cardTitle} !important;
                }
                
                /* General text colors */
                .status-text,
                .pc-card .countdown,
                .action-log-item,
                .idle-card-title,
                .schedule-input,
                .config-input,
                .pc-selector,
                .shortcut-btn {
                    color: ${themeColors.textColor} !important;
                }
                
                /* Schedule list items - comprehensive */
                .schedule-item,
                .schedule-item *,
                .schedule-info,
                .schedule-info *,
                .schedule-time,
                .schedule-details,
                .schedule-countdown,
                .schedule-list,
                .schedule-list * {
                    color: ${themeColors.textColor} !important;
                }
                
                /* Keep some specific accent colors */
                .schedule-countdown {
                    color: #ff6b35 !important;
                }
                
                /* Day checkbox labels */
                .day-checkbox-label,
                .day-checkbox-label span {
                    color: ${themeColors.textColor} !important;
                }
                
                /* Follow-up items */
                .followup-item,
                .followup-item span {
                    color: ${themeColors.textColor} !important;
                    background: ${themeColors.cardBg} !important;
                }
                
                /* Calendar styling */
                #calendar-day-details,
                #calendar-day-details *,
                #calendar-grid,
                #calendar-grid *,
                #calendar-month-label {
                    color: ${themeColors.textColor} !important;
                }
                
                /* Empty schedule message text */
                #schedule-empty-message {
                    color: ${themeColors.textColor};
                }
                
                /* Keyboard shortcut buttons text */
                .shortcuts-section .shortcut-btn,
                .shortcut-btn span {
                    color: ${themeColors.textColor} !important;
                }
                
                /* Action log items */
                .action-log-item,
                .action-log-item * {
                    color: ${themeColors.textColor} !important;
                }
                
                /* Idle card content */
                .idle-card,
                .idle-card *,
                .idle-card-title,
                .idle-details {
                    color: ${themeColors.textColor} !important;
                }
                
                /* Labels and secondary text - exclude wizard */
                .pc-card label,
                .scheduled-section label,
                .shortcuts-section label,
                .idle-section label,
                .action-log label,
                .scheduled-section small,
                .idle-section small {
                    color: ${themeColors.textColor} !important;
                }
                
                /* Secondary text elements that were being missed */
                .led-indicator,
                .led-indicator span,
                .important-banner,
                .important-banner strong,
                .btn-clear,
                .config-section p,
                #schedule-empty-message,
                .recurring-options-box label,
                .schedule-item-row div,
                [style*="text-secondary"] {
                    color: ${themeColors.textColor} !important;
                }
                
                /* Border colors for boxes */
                .status-indicator,
                .recurring-options-box,
                .schedule-input,
                .config-input,
                .pc-selector {
                    border-color: ${computeBorder(themeColors.textColor, themeColors.inputBg)} !important;
                }
                
                /* Day checkbox - use computed border normally, orange when checked */
                .day-checkbox-label {
                    border-color: ${computeBorder(themeColors.textColor, themeColors.inputBg)} !important;
                }
                .day-checkbox-label:has(input:checked) {
                    border-color: #ff9800 !important;
                    background: rgba(255, 152, 0, 0.15) !important;
                }
                .day-checkbox-label:hover {
                    border-color: rgba(255, 152, 0, 0.5) !important;
                }
                
                /* Select dropdown options */
                .schedule-input option,
                .pc-selector option,
                select option {
                    background: ${themeColors.inputBg} !important;
                    color: ${themeColors.textColor} !important;
                }
                
                /* Hamburger menu panel */
                .menu-content {
                    background: ${themeColors.cardBg} !important;
                }
                .menu-header {
                    border-color: ${themeColors.inputBg} !important;
                }
                .menu-header h2 {
                    color: ${themeColors.cardTitle} !important;
                }
                .menu-close {
                    color: ${themeColors.textColor} !important;
                }
                .menu-item {
                    color: ${themeColors.textColor} !important;
                }
                .menu-item:hover,
                .menu-item-with-toggle:hover {
                    background: ${themeColors.inputBg} !important;
                }
                .menu-divider {
                    background: ${themeColors.inputBg} !important;
                }
                .menu-toggle-slider {
                    background-color: ${themeColors.inputBg} !important;
                    box-shadow: inset 0 1px 3px rgba(0,0,0,0.3) !important;
                }
                .menu-toggle input:checked + .menu-toggle-slider {
                    background-color: #ff8c00 !important;
                    box-shadow: inset 0 1px 3px rgba(0,0,0,0.3) !important;
                }
                .slider {
                    background-color: ${themeColors.inputBg} !important;
                    box-shadow: inset 0 1px 3px rgba(0,0,0,0.3) !important;
                }
                input:checked + .slider {
                    background-color: #ff8c00 !important;
                    box-shadow: inset 0 1px 3px rgba(0,0,0,0.3) !important;
                }
                
                /* Add Schedule button - solid orange */
                .btn-save {
                    background: #ff8c00 !important;
                }
                
                /* Wizard/Settings/Login/Modals: always dark mode - override theme colors */
                .setup-wizard,
                .setup-wizard h3,
                .setup-wizard p,
                .setup-wizard label,
                .setup-wizard small,
                .setup-wizard span,
                .setup-wizard div,
                .setup-wizard .wizard-label,
                .setup-wizard .wizard-radio-label,
                .setup-wizard .wizard-radio-desc,
                .setup-wizard .pc-config-header h3,
                .setup-wizard .wizard-step-label,
                .setup-wizard .feature-toggle span,
                .setup-wizard .feature-toggle label,
                .login-container,
                .login-container *,
                .modal,
                .modal * {
                    color: #e0e0e0 !important;
                }
                .setup-wizard .pc-config-number,
                .setup-wizard .wizard-btn-primary,
                .setup-wizard .wizard-step-number {
                    color: white !important;
                }
                .setup-wizard .wizard-container,
                .setup-wizard .wizard-body {
                    background: #2a2a2a !important;
                }
                .setup-wizard .wizard-header {
                    background: #1e1e1e !important;
                }
                .setup-wizard .wizard-footer {
                    background: #1e1e1e !important;
                }
                .setup-wizard .pc-config-card {
                    background: #1e1e1e !important;
                    border-color: #3a3a3a !important;
                }
                .setup-wizard .wizard-input,
                .setup-wizard .wizard-radio-option {
                    background: #1e1e1e !important;
                    border-color: #3a3a3a !important;
                    color: #e0e0e0 !important;
                }
                .setup-wizard select option {
                    background: #1e1e1e !important;
                    color: #e0e0e0 !important;
                }
                .setup-wizard .wizard-radio-option.selected {
                    border-color: #ff6b35 !important;
                }
                .setup-wizard .icon-option {
                    border-color: #3a3a3a !important;
                }
                .setup-wizard .icon-option.selected {
                    border-color: #ff6b35 !important;
                }
            `;
            
            // Remove old style if exists
            const oldStyle = document.getElementById('theme-colors');
            if (oldStyle) oldStyle.remove();
            
            document.head.appendChild(style);
        }
        
        function buildPCCards(config) {
            const container = document.querySelector('.pc-cards');
            if (!container) return;
            
            // Clear existing cards
            container.innerHTML = '';
            
            // Build card for each PC
            config.pcs.forEach(pc => {
                const card = createPCCard(pc, config.hardware.hasSwitch);
                container.appendChild(card);
            });
        }
        
        function createPCCard(pc, hasSwitch) {
            const card = document.createElement('div');
            card.className = 'pc-card';
            card.id = `pc-card-${pc.port}`;
            
            // Determine icon display (emoji or image)
            let iconHTML = pc.icon;
            if (pc.iconType === 'image' || (typeof pc.icon === 'string' && pc.icon.startsWith('/'))) {
                iconHTML = `<img src="${pc.icon}" style="height: 30px; width: auto; object-fit: contain;">`;
            }
            
            card.innerHTML = `
                <div class="pc-name">
                    <span>${pc.name}</span>
                    <span class="pc-icon">${iconHTML}</span>
                </div>
                
                <div class="status-indicator">
                    <div class="status-indicators">
                        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="status-dot checking" id="status-dot-${pc.port}"></div>
                                <div class="status-text" id="status-text-${pc.port}">Checking...</div>
                            </div>
                            <div class="led-indicator" style="margin-left: auto; text-align: right;">
                                <span>HDD Activity</span>
                                <div class="led-dot" id="hdd-led-${pc.port}"></div>
                            </div>
                            </div>
                        </div>
                        <div class="countdown" id="uptime-${pc.port}" style="color: var(--text-secondary); font-size: 0.85em; margin-bottom: 4px;">Uptime: --</div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div class="countdown" id="countdown-${pc.port}" style="margin: 0;"></div>
                            ${hasSwitch ? `<div style="color: var(--text-secondary); font-size: 0.85em; font-weight: 500;">Port ${pc.port}</div>` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="button-grid">
                    <button class="btn btn-on" id="btn-on-${pc.port}" onclick="powerOn(${pc.port}, '${pc.name}')">Power On</button>
                    <button class="btn btn-off" id="btn-off-${pc.port}" onclick="showShutdownModal(${pc.port}, '${pc.name}')">Power Off</button>
                    <button class="btn btn-reset" id="btn-reset-${pc.port}" onclick="showResetModal(${pc.port}, '${pc.name}')">Reset</button>
                </div>
            `;
            
            return card;
        }
        
        function toggleFeatureVisibility(features) {
            // Keyboard shortcuts
            const keyboardSection = document.getElementById('keyboard-shortcuts-section');
            if (keyboardSection) {
                keyboardSection.style.display = features.keyboardShortcuts ? 'block' : 'none';
            }
            
            // Scheduled actions
            const scheduledSection = document.getElementById('scheduled-actions-section');
            if (scheduledSection) {
                scheduledSection.style.display = features.scheduledActions ? 'block' : 'none';
            }
            
            // Idle shutdown
            const idleSection = document.getElementById('idle-shutdown-section');
            if (idleSection) {
                idleSection.style.display = features.idleShutdown ? 'block' : 'none';
            }
            
            // Action log
            const actionLogSection = document.querySelector('.recent-actions');
            if (actionLogSection) {
                actionLogSection.style.display = features.actionLog ? 'block' : 'none';
            }
            
            // Uptime tracking handled by display of uptime elements
            // HDD activity handled by display of HDD LED elements
            
            // Sound notifications
            if (!features.soundNotifications) {
                soundEnabled = false;
            }
        }
        
        function applyCustomCSS(css) {
            const style = document.createElement('style');
            style.textContent = css;
            style.id = 'custom-user-css';
            document.head.appendChild(style);
        }
        
        // ============ SETUP WIZARD FUNCTIONS ============
        
        async function checkFirstRun() {
            const config = await apiRequest('/config');
            return config && config.firstRun === true;
        }
        
        async function showSetupWizard() {
            // Load custom images before showing wizard
            await loadCustomImages();
            
            isSettingsMode = false; // This is first-run setup, not editing settings
            document.getElementById('setupWizard').classList.add('show');
            buildWizardStep1();
        }
        
        function buildWizardStep1() {
            const body = document.getElementById('wizardBody');
            body.innerHTML = `
                <div class="wizard-step active" id="step1">
                    <div class="step1-header">
                        <h2>Hardware Configuration</h2>
                        <p>Tell us about your PiKVM hardware setup</p>
                        <img src="/pikvm-switch.webp" alt="PiKVM ATX Switch" class="step1-image">
                    </div>

                    <div class="wizard-input-group step1-content">
                        <label class="wizard-label">Do you have one or more PiKVM ATX switches installed?</label>
                        <div class="wizard-radio-group">
                            <div class="wizard-radio-option ${wizardConfig.hardware?.hasSwitch === true ? 'selected' : ''}" onclick="selectSwitch(true)">
                                <span class="wizard-radio-label"> Yes</span>
                                <span class="wizard-radio-desc">Multi-port ATX control</span>
                            </div>
                            <div class="wizard-radio-option ${wizardConfig.hardware?.hasSwitch === false ? 'selected' : ''}" onclick="selectSwitch(false)">
                                <span class="wizard-radio-label"> No</span>
                                <span class="wizard-radio-desc">Direct connection (1 PC)</span>
                            </div>
                        </div>
                    </div>

                    <div class="wizard-input-group" id="pcCountGroup" style="display: ${wizardConfig.hardware?.hasSwitch ? 'block' : 'none'};">
                        <label class="wizard-label">How many PCs do you want to control?</label>
                        <input type="number" id="pcCount" class="wizard-input" min="1" max="20" value="${wizardConfig.hardware?.pcCount || 2}">
                        <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                             You can control up to 20 PCs with daisy-chained switches (5 switches  4 ports)
                        </small>
                    </div>
                </div>
            `;
            
            // Disable Next button until switch option is selected
            const nextBtn = document.getElementById('wizardNext');
            if (nextBtn && wizardCurrentStep === 1) {
                nextBtn.disabled = wizardConfig.hardware?.hasSwitch === undefined;
            }
        }
        
        function selectSwitch(hasSwitch) {
            wizardConfig.hardware = wizardConfig.hardware || {};
            wizardConfig.hardware.hasSwitch = hasSwitch;
            
            // Update UI
            document.querySelectorAll('.wizard-radio-option').forEach(opt => opt.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            // Show/hide PC count
            const pcCountGroup = document.getElementById('pcCountGroup');
            if (hasSwitch) {
                pcCountGroup.style.display = 'block';
            } else {
                pcCountGroup.style.display = 'none';
                wizardConfig.hardware.pcCount = 1;
            }
            
            // Enable Next button now that an option is selected
            const nextBtn = document.getElementById('wizardNext');
            if (nextBtn) {
                nextBtn.disabled = false;
            }
        }
        
        function wizardNextStep() {
            // Validate and save current step
            if (wizardCurrentStep === 1) {
                if (!wizardConfig.hardware || wizardConfig.hardware.hasSwitch === undefined) {
                    showToast('Please select whether you have a switch', 'error');
                    return;
                }
                if (wizardConfig.hardware.hasSwitch) {
                    const count = parseInt(document.getElementById('pcCount').value);
                    if (!count || count < 1 || count > 20) {
                        showToast('Please enter a valid PC count (1-20)', 'error');
                        return;
                    }
                    wizardConfig.hardware.pcCount = count;
                }
                buildWizardStep2();
            } else if (wizardCurrentStep === 2) {
                if (!validatePCConfig()) return;
                buildWizardStep3();
            } else if (wizardCurrentStep === 3) {
                saveAppearanceConfig();
                buildWizardStep4();
            } else if (wizardCurrentStep === 4) {
                saveFeaturesConfig();
                buildWizardStep5();
            } else if (wizardCurrentStep === 5) {
                saveAdvancedConfig();
                buildWizardStep6();
            }
            
            wizardCurrentStep++;
            updateWizardProgress();
            
            // Scroll wizard body to top
            document.getElementById('wizardBody').scrollTop = 0;
        }
        
        function wizardPrevStep() {
            // Save current step data before moving
            if (wizardCurrentStep === 2) {
                validatePCConfig(); // Save without showing errors
            }
            
            wizardCurrentStep--;
            
            if (wizardCurrentStep === 1) buildWizardStep1();
            else if (wizardCurrentStep === 2) buildWizardStep2();
            else if (wizardCurrentStep === 3) buildWizardStep3();
            else if (wizardCurrentStep === 4) buildWizardStep4();
            else if (wizardCurrentStep === 5) buildWizardStep5();
            
            updateWizardProgress();
        }
        
        function updateWizardProgress() {
            // Update progress indicators
            document.querySelectorAll('.wizard-step-indicator').forEach((ind, idx) => {
                ind.classList.remove('active', 'completed');
                
                if (isSettingsMode) {
                    // In settings mode: all steps except current are completed (green)
                    if (idx + 1 !== wizardCurrentStep) ind.classList.add('completed');
                    if (idx + 1 === wizardCurrentStep) ind.classList.add('active');
                } else {
                    // In first-run mode: only steps before current are completed
                    if (idx + 1 < wizardCurrentStep) ind.classList.add('completed');
                    if (idx + 1 === wizardCurrentStep) ind.classList.add('active');
                }
            });
            
            // Update buttons based on mode
            document.getElementById('wizardPrev').disabled = wizardCurrentStep === 1;
            
            if (isSettingsMode) {
                // In settings mode: show Save Settings button, hide Skip/Next/Finish
                document.getElementById('wizardSkip').style.display = 'none';
                document.getElementById('wizardNext').style.display = 'none';
                document.getElementById('wizardFinish').style.display = 'none';
                document.getElementById('wizardSave').style.display = 'inline-block';
            } else {
                // In first-run mode: show Skip/Next/Finish, hide Save Settings
                document.getElementById('wizardSkip').style.display = 'inline-block';
                document.getElementById('wizardSave').style.display = 'none';
                document.getElementById('wizardNext').style.display = wizardCurrentStep === 6 ? 'none' : 'inline-block';
                document.getElementById('wizardFinish').style.display = wizardCurrentStep === 6 ? 'inline-block' : 'none';
            }
        }
        
        function goToWizardStep(targetStep) {
            // Save current step data before navigating (always, not just in settings mode)
            if (wizardCurrentStep === 2) {
                validatePCConfig(); // Save PC config without blocking navigation
            }
            // Could add other step validations here in the future
            // if (wizardCurrentStep === 3) { saveAppearanceConfig(); }
            
            // In settings mode, allow navigation to any step
            // In first-run mode, can't skip ahead
            if (!isSettingsMode && targetStep > wizardCurrentStep + 1) {
                showToast('Please complete steps in order', 'error');
                return;
            }
            
            // Build the target step
            if (targetStep === 1) buildWizardStep1();
            else if (targetStep === 2) buildWizardStep2();
            else if (targetStep === 3) buildWizardStep3();
            else if (targetStep === 4) buildWizardStep4();
            else if (targetStep === 5) buildWizardStep5();
            else if (targetStep === 6) buildWizardStep6();
            
            wizardCurrentStep = targetStep;
            updateWizardProgress();
            document.getElementById('wizardBody').scrollTop = 0;
        }
        
        function buildWizardStep2() {
            const pcCount = wizardConfig.hardware.pcCount || 1;
            wizardConfig.pcs = wizardConfig.pcs || [];
            
            let pcsHTML = '';
            for (let i = 0; i < pcCount; i++) {
                const pc = wizardConfig.pcs[i] || { id: i, name: `PC ${i + 1}`, port: i, icon: '' };
                pcsHTML += `
                    <div class="pc-config-card">
                        <div class="pc-config-header">
                            <span class="pc-config-number">${i + 1}</span>
                            <h3 style="margin: 0;">Configure PC ${i + 1}</h3>
                        </div>
                        <div class="wizard-input-group">
                            <label class="wizard-label">PC Name</label>
                            <input type="text" class="wizard-input" id="pc-name-${i}" value="${pc.name}">
                        </div>
                        ${wizardConfig.hardware.hasSwitch ? `
                        <div class="wizard-input-group">
                            <label class="wizard-label">Port Number</label>
                            <input type="number" class="wizard-input" id="pc-port-${i}" value="${pc.port}" min="0" max="19">
                            <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                                 Ports are 0-indexed (first port = 0, second = 1, etc.)
                            </small>
                        </div>
                        ` : ''}
                        <div class="wizard-input-group">
                            <label class="wizard-label">Icon</label>
                            <div class="icon-selector" id="icon-selector-${i}">
                                ${Object.entries(ICON_OPTIONS).map(([key, emoji]) => `
                                    <div class="icon-option ${pc.icon === emoji ? 'selected' : ''}" 
                                         onclick="selectIcon(${i}, '${emoji}', 'emoji')">${emoji}</div>
                                `).join('')}
                                <!-- Upload Icon Box -->
                                <div class="icon-option icon-upload-box" id="upload-box-${i}" onclick="handleUploadBoxClick(${i})" 
                                     title="Click to select this option, then click again to choose a file">
                                    <input type="file" id="icon-upload-${i}" accept="image/png,image/jpeg,image/svg+xml,image/gif,image/webp" style="display: none;" onchange="handleIconUpload(event, ${i})">
                                    <div id="upload-preview-${i}" class="upload-preview-container">
                                        <img id="upload-preview-img-${i}" src="" style="max-height: 45px; width: auto; object-fit: contain;">
                                    </div>
                                    <div id="upload-icon-${i}" class="upload-icon-container">
                                        <svg width="40" height="40" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                            <!-- Grey background circle -->
                                            <circle cx="50" cy="50" r="48" fill="#999999" stroke="#666666" stroke-width="2"/>
                                            <!-- Black arrow pointing up -->
                                            <path d="M 50 25 L 35 45 L 44 45 L 44 65 L 56 65 L 56 45 L 65 45 Z" fill="#1a1a1a"/>
                                            <!-- Black horizontal line at bottom -->
                                            <rect x="30" y="70" width="40" height="6" fill="#1a1a1a" rx="2"/>
                                        </svg>
                                    </div>
                                </div>
                                ${CUSTOM_IMAGES.map(img => {
                                    const isSelected = pc.icon === img || pc.icon === `/dashboard-images/${img}`;
                                    return `
                                    <div class="icon-option ${isSelected ? 'selected' : ''}" 
                                         onclick="selectIcon(${i}, '/dashboard-images/${img}', 'image')"
                                         title="${img}">
                                        <img src="/dashboard-images/${img}" style="max-width: 45px; max-height: 45px; object-fit: contain;">
                                    </div>
                                `;
                                }).join('')}
                            </div>
                            ${CUSTOM_IMAGES.length > 0 ? `
                                <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                                     ${CUSTOM_IMAGES.length} custom image${CUSTOM_IMAGES.length !== 1 ? 's' : ''} available  Click upload icon to add more
                                </small>
                            ` : `
                                <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                                     Click upload icon () to add custom icon  Recommended: PNG, 256x256px, transparent background
                                </small>
                            `}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('wizardBody').innerHTML = `
                <div class="wizard-step active">
                    <h2>Configure Your PCs</h2>
                    <p>Set a name, port, and icon for each computer</p>
                    <div>
                        ${pcsHTML}
                    </div>
                </div>
            `;
            
            // After building, check if any PCs have uploaded icons and show them
            for (let i = 0; i < pcCount; i++) {
                const pc = wizardConfig.pcs[i];
                if (pc && pc.iconType === 'image' && pc.icon && pc.icon.startsWith('/dashboard-images/')) {
                    // Show the uploaded icon in the preview
                    const previewContainer = document.getElementById(`upload-preview-${i}`);
                    const previewImg = document.getElementById(`upload-preview-img-${i}`);
                    const uploadIcon = document.getElementById(`upload-icon-${i}`);
                    const uploadBox = document.getElementById(`upload-box-${i}`);
                    
                    if (previewContainer && previewImg && uploadIcon && uploadBox) {
                        previewImg.src = pc.icon;
                        previewContainer.style.display = 'flex';
                        uploadIcon.style.display = 'none';
                        uploadBox.classList.add('selected');
                    }
                }
            }
        }
        
        function selectIcon(pcIndex, icon, iconType = 'emoji') {
            document.querySelectorAll(`#icon-selector-${pcIndex} .icon-option`).forEach(opt => 
                opt.classList.remove('selected')
            );
            event.currentTarget.classList.add('selected');
            
            wizardConfig.pcs = wizardConfig.pcs || [];
            wizardConfig.pcs[pcIndex] = wizardConfig.pcs[pcIndex] || {};
            wizardConfig.pcs[pcIndex].icon = icon;
            wizardConfig.pcs[pcIndex].iconType = iconType;
        }
        
        function handleUploadBoxClick(pcIndex) {
            const uploadBox = document.getElementById(`upload-box-${pcIndex}`);
            const isSelected = uploadBox.classList.contains('selected');
            
            if (isSelected) {
                // Already selected, open file picker
                document.getElementById(`icon-upload-${pcIndex}`).click();
            } else {
                // Not selected, select it first
                document.querySelectorAll(`#icon-selector-${pcIndex} .icon-option`).forEach(opt => 
                    opt.classList.remove('selected')
                );
                uploadBox.classList.add('selected');
                
                // Mark as upload type in config (will be updated when file is chosen)
                wizardConfig.pcs = wizardConfig.pcs || [];
                wizardConfig.pcs[pcIndex] = wizardConfig.pcs[pcIndex] || {};
                wizardConfig.pcs[pcIndex].iconType = 'upload';
            }
        }
        
        async function handleIconUpload(event, pcIndex) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            const validTypes = ['image/png', 'image/jpeg', 'image/svg+xml', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showToast(' Please upload a valid image file (PNG, JPG, SVG, GIF, or WebP)', 'error');
                return;
            }
            
            // Validate file size (max 5MB)
            const maxSize = 5 * 1024 * 1024;
            if (file.size > maxSize) {
                showToast(' Image too large. Please use an image under 5MB', 'error');
                return;
            }
            
            // Show preview immediately
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImg = document.getElementById(`upload-preview-img-${pcIndex}`);
                const previewDiv = document.getElementById(`upload-preview-${pcIndex}`);
                const uploadIcon = document.getElementById(`upload-icon-${pcIndex}`);
                
                if (previewImg && previewDiv && uploadIcon) {
                    previewImg.src = e.target.result;
                    previewDiv.style.display = 'block';
                    uploadIcon.style.display = 'none';
                }
            };
            reader.readAsDataURL(file);
            
            // Show upload progress
            showToast(' Uploading icon...', 'info');
            
            try {
                // Create form data
                const formData = new FormData();
                formData.append('file', file);
                
                // Upload to backend
                const response = await fetch('/api/dashboard/upload-icon', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast(` Icon uploaded: ${result.filename}`, 'success');
                    
                    // Reload custom images
                    await loadCustomImages();
                    
                    // Update the config with the uploaded icon
                    const imagePath = `/dashboard-images/${result.filename}`;
                    wizardConfig.pcs = wizardConfig.pcs || [];
                    wizardConfig.pcs[pcIndex] = wizardConfig.pcs[pcIndex] || {};
                    wizardConfig.pcs[pcIndex].icon = imagePath;
                    wizardConfig.pcs[pcIndex].iconType = 'image';
                    
                    // Keep upload box selected and show uploaded image
                    const uploadBox = document.getElementById(`upload-box-${pcIndex}`);
                    if (uploadBox) {
                        uploadBox.classList.add('selected');
                    }
                    
                    // No need to rebuild - the preview is already showing from the FileReader
                } else {
                    showToast(` Upload failed: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showToast(' Upload failed. Please try again.', 'error');
            }
            
            // Reset file input
            event.target.value = '';
        }
        
        function selectIconProgrammatically(pcIndex, icon, iconType) {
            // Find and select the icon
            const iconElements = document.querySelectorAll(`#icon-selector-${pcIndex} .icon-option`);
            iconElements.forEach(el => {
                el.classList.remove('selected');
                const img = el.querySelector('img');
                if (img && img.src.includes(icon)) {
                    el.classList.add('selected');
                }
            });
            
            // Update config
            wizardConfig.pcs = wizardConfig.pcs || [];
            wizardConfig.pcs[pcIndex] = wizardConfig.pcs[pcIndex] || {};
            wizardConfig.pcs[pcIndex].icon = icon;
            wizardConfig.pcs[pcIndex].iconType = iconType;
        }
        
        function validatePCConfig() {
            const pcCount = wizardConfig.hardware.pcCount || 1;
            const savedPCs = wizardConfig.pcs || [];
            wizardConfig.pcs = [];
            
            for (let i = 0; i < pcCount; i++) {
                const name = document.getElementById(`pc-name-${i}`).value.trim();
                const port = wizardConfig.hardware.hasSwitch ? 
                    parseInt(document.getElementById(`pc-port-${i}`).value) : 0;
                
                if (!name) {
                    showToast(`Please enter a name for PC ${i + 1}`, 'error');
                    return false;
                }
                
                // Preserve existing icon and iconType, or use default
                const existingPC = savedPCs[i] || {};
                const icon = existingPC.icon || '';
                const iconType = existingPC.iconType || 'emoji';
                
                wizardConfig.pcs.push({
                    id: i,
                    name: name,
                    port: port,
                    icon: icon,
                    iconType: iconType
                });
            }
            return true;
        }
        
        function buildWizardStep3() {
            wizardConfig.appearance = wizardConfig.appearance || {
                theme: 'default',
                mode: 'dark',
                customColors: {
                    light: THEME_PRESETS.default.light,
                    dark: THEME_PRESETS.default.dark
                },
                backgroundImage: '',
                logo: '/logo.png',
                dashboardTitle: 'Control Dashboard'
            };
            
            // Ensure customColors exists
            if (!wizardConfig.appearance.customColors) {
                const currentTheme = wizardConfig.appearance.theme || 'default';
                wizardConfig.appearance.customColors = {
                    light: {...THEME_PRESETS[currentTheme].light},
                    dark: {...THEME_PRESETS[currentTheme].dark}
                };
            }
            
            document.getElementById('wizardBody').innerHTML = `
                <div class="wizard-step active">
                    <h2>Customize Appearance</h2>
                    <p>Choose colors and themes</p>
                    
                    <!-- Color Pickers at Top - Two Column Layout -->
                    <div class="wizard-input-group">
                        <label class="wizard-label">Color Customization</label>
                        <div id="color-customization-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- Light Mode Column -->
                            <div>
                                <h3 style="font-size: 1.1em; margin-bottom: 15px; color: var(--text-primary);"> Light Mode</h3>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-secondary); display: block; margin-bottom: 5px;">Card Title</label>
                                        <input type="color" id="colorLightCardTitle" class="color-picker" 
                                               value="${wizardConfig.appearance.customColors.light.cardTitle}" 
                                               onchange="onColorChange()" 
                                               style="width: 100%; height: 45px; cursor: pointer; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-secondary); display: block; margin-bottom: 5px;">Card Background</label>
                                        <input type="color" id="colorLightCardBg" class="color-picker" 
                                               value="${wizardConfig.appearance.customColors.light.cardBg}" 
                                               onchange="onColorChange()" 
                                               style="width: 100%; height: 45px; cursor: pointer; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-secondary); display: block; margin-bottom: 5px;">Input/Status Bg</label>
                                        <input type="color" id="colorLightInputBg" class="color-picker" 
                                               value="${wizardConfig.appearance.customColors.light.inputBg || '#c5ccd3'}" 
                                               onchange="onColorChange()" 
                                               style="width: 100%; height: 45px; cursor: pointer; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-secondary); display: block; margin-bottom: 5px;">Button Background</label>
                                        <input type="color" id="colorLightButtonBg" class="color-picker" 
                                               value="${wizardConfig.appearance.customColors.light.buttonBg}" 
                                               onchange="onColorChange()" 
                                               style="width: 100%; height: 45px; cursor: pointer; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-secondary); display: block; margin-bottom: 5px;">Site Background</label>
                                        <input type="color" id="colorLightSiteBg" class="color-picker" 
                                               value="${wizardConfig.appearance.customColors.light.siteBg}" 
                                               onchange="onColorChange()" 
                                               style="width: 100%; height: 45px; cursor: pointer; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-secondary); display: block; margin-bottom: 5px;">Text Color</label>
                                        <input type="color" id="colorLightTextColor" class="color-picker" 
                                               value="${wizardConfig.appearance.customColors.light.textColor}" 
                                               onchange="onColorChange()" 
                                               style="width: 100%; height: 45px; cursor: pointer; border-radius: 6px;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Dark Mode Column -->
                            <div>
                                <h3 style="font-size: 1.1em; margin-bottom: 15px; color: var(--text-primary);"> Dark Mode</h3>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-secondary); display: block; margin-bottom: 5px;">Card Title</label>
                                        <input type="color" id="colorDarkCardTitle" class="color-picker" 
                                               value="${wizardConfig.appearance.customColors.dark.cardTitle}" 
                                               onchange="onColorChange()" 
                                               style="width: 100%; height: 45px; cursor: pointer; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-secondary); display: block; margin-bottom: 5px;">Card Background</label>
                                        <input type="color" id="colorDarkCardBg" class="color-picker" 
                                               value="${wizardConfig.appearance.customColors.dark.cardBg}" 
                                               onchange="onColorChange()" 
                                               style="width: 100%; height: 45px; cursor: pointer; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-secondary); display: block; margin-bottom: 5px;">Input/Status Bg</label>
                                        <input type="color" id="colorDarkInputBg" class="color-picker" 
                                               value="${wizardConfig.appearance.customColors.dark.inputBg || '#1e1e1e'}" 
                                               onchange="onColorChange()" 
                                               style="width: 100%; height: 45px; cursor: pointer; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-secondary); display: block; margin-bottom: 5px;">Button Background</label>
                                        <input type="color" id="colorDarkButtonBg" class="color-picker" 
                                               value="${wizardConfig.appearance.customColors.dark.buttonBg}" 
                                               onchange="onColorChange()" 
                                               style="width: 100%; height: 45px; cursor: pointer; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-secondary); display: block; margin-bottom: 5px;">Site Background</label>
                                        <input type="color" id="colorDarkSiteBg" class="color-picker" 
                                               value="${wizardConfig.appearance.customColors.dark.siteBg}" 
                                               onchange="onColorChange()" 
                                               style="width: 100%; height: 45px; cursor: pointer; border-radius: 6px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 0.85em; color: var(--text-secondary); display: block; margin-bottom: 5px;">Text Color</label>
                                        <input type="color" id="colorDarkTextColor" class="color-picker" 
                                               value="${wizardConfig.appearance.customColors.dark.textColor}" 
                                               onchange="onColorChange()" 
                                               style="width: 100%; height: 45px; cursor: pointer; border-radius: 6px;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Theme Presets Below -->
                    <div class="wizard-input-group">
                        <label class="wizard-label">Theme Presets</label>
                        <small style="color: var(--text-secondary); display: block; margin-bottom: 10px;">
                            Select a preset to load its colors, then customize as needed
                        </small>
                        <div class="preset-themes">
                            ${Object.keys(THEME_PRESETS).map(theme => {
                                const preset = THEME_PRESETS[theme];
                                const isSelected = wizardConfig.appearance.theme === theme;
                                return `
                                <div class="theme-preset ${isSelected ? 'selected' : ''}" 
                                     onclick="selectThemePreset('${theme}')">
                                    <span style="font-size: 2em;">${preset.emoji}</span>
                                    <div style="font-weight: 600; margin-top: 10px; text-transform: capitalize;">${theme}</div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                    
                    <div class="wizard-input-group">
                        <label class="wizard-label">Default Mode</label>
                        <div class="wizard-radio-group">
                            <div class="wizard-radio-option ${wizardConfig.appearance.mode === 'light' ? 'selected' : ''}" 
                                 onclick="selectMode('light')">
                                <span class="wizard-radio-label"> Light</span>
                                <span class="wizard-radio-desc">Bright interface</span>
                            </div>
                            <div class="wizard-radio-option ${wizardConfig.appearance.mode === 'dark' ? 'selected' : ''}" 
                                 onclick="selectMode('dark')">
                                <span class="wizard-radio-label"> Dark</span>
                                <span class="wizard-radio-desc">Easy on the eyes</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="wizard-input-group">
                        <label class="wizard-label">Background Image URL (optional)</label>
                        <input type="url" id="backgroundImage" class="wizard-input" 
                               value="${wizardConfig.appearance.backgroundImage || ''}"
                               placeholder="https://example.com/background.jpg">
                        <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                            Leave empty to use solid background color
                        </small>
                    </div>
                    
                    <div class="wizard-input-group">
                        <label class="wizard-label">Logo URL</label>
                        <input type="url" id="logoURL" class="wizard-input" 
                               value="${wizardConfig.appearance.logo}"
                               placeholder="/logo.png">
                        <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                            Default: PiKVM Logo
                        </small>
                    </div>
                    
                    <div class="wizard-input-group">
                        <label class="wizard-label">Dashboard Title</label>
                        <input type="text" id="dashboardTitle" class="wizard-input" 
                               value="${wizardConfig.appearance.dashboardTitle}"
                               placeholder="Control Dashboard">
                    </div>
                </div>
            `;
        }
        
        function selectMode(mode) {
            wizardConfig.appearance.mode = mode;
            document.querySelectorAll('#wizardBody .wizard-radio-option').forEach(opt => 
                opt.classList.remove('selected')
            );
            event.currentTarget.classList.add('selected');
        }
        
        function selectThemePreset(themeName) {
            wizardConfig.appearance.theme = themeName;
            document.querySelectorAll('.theme-preset').forEach(preset => 
                preset.classList.remove('selected')
            );
            event.currentTarget.classList.add('selected');
            
            // Load preset colors into the color pickers
            const preset = THEME_PRESETS[themeName];
            if (preset) {
                // Update Light Mode pickers
                document.getElementById('colorLightCardTitle').value = preset.light.cardTitle;
                document.getElementById('colorLightCardBg').value = preset.light.cardBg;
                document.getElementById('colorLightInputBg').value = preset.light.inputBg;
                document.getElementById('colorLightButtonBg').value = preset.light.buttonBg;
                document.getElementById('colorLightSiteBg').value = preset.light.siteBg;
                document.getElementById('colorLightTextColor').value = preset.light.textColor;
                
                // Update Dark Mode pickers
                document.getElementById('colorDarkCardTitle').value = preset.dark.cardTitle;
                document.getElementById('colorDarkCardBg').value = preset.dark.cardBg;
                document.getElementById('colorDarkInputBg').value = preset.dark.inputBg;
                document.getElementById('colorDarkButtonBg').value = preset.dark.buttonBg;
                document.getElementById('colorDarkSiteBg').value = preset.dark.siteBg;
                document.getElementById('colorDarkTextColor').value = preset.dark.textColor;
                
                // Update customColors in config
                wizardConfig.appearance.customColors = {
                    light: {...preset.light},
                    dark: {...preset.dark}
                };
            }
        }
        
        function onColorChange() {
            // When user modifies any color, automatically switch to Custom theme
            wizardConfig.appearance.theme = 'custom';
            
            // Update the selected theme preset visually
            document.querySelectorAll('.theme-preset').forEach(preset => 
                preset.classList.remove('selected')
            );
            document.querySelector('.theme-preset[onclick*="custom"]').classList.add('selected');
            
            // Update customColors in config with current picker values
            wizardConfig.appearance.customColors = {
                light: {
                    cardTitle: document.getElementById('colorLightCardTitle').value,
                    cardBg: document.getElementById('colorLightCardBg').value,
                    inputBg: document.getElementById('colorLightInputBg').value,
                    buttonBg: document.getElementById('colorLightButtonBg').value,
                    siteBg: document.getElementById('colorLightSiteBg').value,
                    textColor: document.getElementById('colorLightTextColor').value
                },
                dark: {
                    cardTitle: document.getElementById('colorDarkCardTitle').value,
                    cardBg: document.getElementById('colorDarkCardBg').value,
                    inputBg: document.getElementById('colorDarkInputBg').value,
                    buttonBg: document.getElementById('colorDarkButtonBg').value,
                    siteBg: document.getElementById('colorDarkSiteBg').value,
                    textColor: document.getElementById('colorDarkTextColor').value
                }
            };
            
            // Update THEME_PRESETS.custom
            THEME_PRESETS.custom.light = {...wizardConfig.appearance.customColors.light};
            THEME_PRESETS.custom.dark = {...wizardConfig.appearance.customColors.dark};
        }
        
        function saveAppearanceConfig() {
            // Always save current color picker values
            const customColors = {
                light: {
                    cardTitle: document.getElementById('colorLightCardTitle').value,
                    cardBg: document.getElementById('colorLightCardBg').value,
                    inputBg: document.getElementById('colorLightInputBg').value,
                    buttonBg: document.getElementById('colorLightButtonBg').value,
                    siteBg: document.getElementById('colorLightSiteBg').value,
                    textColor: document.getElementById('colorLightTextColor').value
                },
                dark: {
                    cardTitle: document.getElementById('colorDarkCardTitle').value,
                    cardBg: document.getElementById('colorDarkCardBg').value,
                    inputBg: document.getElementById('colorDarkInputBg').value,
                    buttonBg: document.getElementById('colorDarkButtonBg').value,
                    siteBg: document.getElementById('colorDarkSiteBg').value,
                    textColor: document.getElementById('colorDarkTextColor').value
                }
            };
            
            wizardConfig.appearance = {
                theme: wizardConfig.appearance.theme || 'default',
                mode: wizardConfig.appearance.mode || 'dark',
                customColors: customColors,
                backgroundImage: document.getElementById('backgroundImage').value,
                logo: document.getElementById('logoURL').value,
                dashboardTitle: document.getElementById('dashboardTitle').value
            };
            
            // Update THEME_PRESETS.custom with current colors
            THEME_PRESETS.custom.light = {...customColors.light};
            THEME_PRESETS.custom.dark = {...customColors.dark};
        }
        
        function buildWizardStep4() {
            wizardConfig.features = wizardConfig.features || {
                keyboardShortcuts: true,
                scheduledActions: true,
                idleShutdown: true,
                actionLog: true,
                uptimeTracking: true,
                soundNotifications: true,
                hddActivity: true
            };
            
            document.getElementById('wizardBody').innerHTML = `
                <div class="wizard-step active">
                    <h2>Enable Features</h2>
                    <p>Activate features you want on the dashboard</p>
                    <div class="feature-toggle-list">
                        ${[
                            ['keyboard', 'keyboardShortcuts', ' Keyboard Shortcuts'],
                            ['scheduled', 'scheduledActions', ' Scheduled Actions'],
                            ['idle', 'idleShutdown', ' Idle Auto-Shutdown'],
                            ['actionlog', 'actionLog', ' Action Log'],
                            ['uptime', 'uptimeTracking', ' Uptime Tracking'],
                            ['sound', 'soundNotifications', ' Sound Notifications'],
                            ['hdd', 'hddActivity', ' HDD Activity']
                        ].map(([id, key, label]) => `
                            <div class="feature-toggle">
                                <span>${label}</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="feature-${id}" ${wizardConfig.features[key] ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function saveFeaturesConfig() {
            wizardConfig.features = {
                keyboardShortcuts: document.getElementById('feature-keyboard').checked,
                scheduledActions: document.getElementById('feature-scheduled').checked,
                idleShutdown: document.getElementById('feature-idle').checked,
                actionLog: document.getElementById('feature-actionlog').checked,
                uptimeTracking: document.getElementById('feature-uptime').checked,
                soundNotifications: document.getElementById('feature-sound').checked,
                hddActivity: document.getElementById('feature-hdd').checked
            };
        }
        
        function buildWizardStep5() {
            wizardConfig.advanced = wizardConfig.advanced || {
                statusCheckInterval: 30000,
                hddCheckInterval: 1000,
                actionLogLimit: 100,
                requireConfirmation: true,
                safeMode: false,
                customCSS: ''
            };
            
            document.getElementById('wizardBody').innerHTML = `
                <div class="wizard-step active">
                    <h2>Advanced Settings</h2>
                    <p>Fine-tune your dashboard (optional)</p>
                    
                    <div class="wizard-input-group">
                        <label class="wizard-label">Status Check Interval (ms)</label>
                        <input type="number" id="statusInterval" class="wizard-input" 
                               value="${wizardConfig.advanced.statusCheckInterval}" min="5000" max="120000" step="1000">
                        <small style="color: var(--text-secondary);">Default: 30000ms (30 seconds)</small>
                    </div>
                    
                    <div class="wizard-input-group">
                        <label class="wizard-label">HDD Check Interval (ms)</label>
                        <input type="number" id="hddInterval" class="wizard-input" 
                               value="${wizardConfig.advanced.hddCheckInterval}" min="500" max="10000" step="500">
                        <small style="color: var(--text-secondary);">Default: 1000ms (1 second)</small>
                    </div>
                    
                    <div class="wizard-input-group">
                        <label class="wizard-label">Action Log Limit</label>
                        <input type="number" id="actionLogLimit" class="wizard-input" 
                               value="${wizardConfig.advanced.actionLogLimit}" min="10" max="1000">
                    </div>
                    
                    <div class="wizard-input-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="requireConfirmation" ${wizardConfig.advanced.requireConfirmation ? 'checked' : ''}>
                            <span>Require confirmation for power actions</span>
                        </label>
                    </div>
                    
                    <div class="wizard-input-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="safeMode" ${wizardConfig.advanced.safeMode ? 'checked' : ''}>
                            <span>Safe Mode (disable force shutdown)</span>
                        </label>
                    </div>
                    
                    <div class="wizard-input-group">
                        <label class="wizard-label">Custom CSS (advanced)</label>
                        <textarea id="customCSS" class="wizard-input" rows="4" 
                                  placeholder="/* Add custom CSS here */">${wizardConfig.advanced.customCSS || ''}</textarea>
                    </div>
                </div>
            `;
        }
        
        function saveAdvancedConfig() {
            wizardConfig.advanced = {
                statusCheckInterval: parseInt(document.getElementById('statusInterval').value),
                hddCheckInterval: parseInt(document.getElementById('hddInterval').value),
                actionLogLimit: parseInt(document.getElementById('actionLogLimit').value),
                requireConfirmation: document.getElementById('requireConfirmation').checked,
                safeMode: document.getElementById('safeMode').checked,
                customCSS: document.getElementById('customCSS').value
            };
        }
        
        function buildWizardStep6() {
            const themeName = wizardConfig.appearance?.theme || 'default';
            const mode = wizardConfig.appearance?.mode || 'dark';
            
            const summary = `
                <div style="display: grid; gap: 20px;">
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid #ff6b35;">
                        <h3 style="margin: 0 0 10px 0; color: #ff6b35;"> Hardware</h3>
                        <p style="margin: 5px 0;"><strong>ATX Switch:</strong> ${wizardConfig.hardware.hasSwitch ? 'Yes' : 'No'}</p>
                        <p style="margin: 5px 0;"><strong>PC Count:</strong> ${wizardConfig.hardware.pcCount || 1}</p>
                    </div>
                    
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid #ff6b35;">
                        <h3 style="margin: 0 0 10px 0; color: #ff6b35;"> PCs Configured</h3>
                        ${wizardConfig.pcs.map(pc => `
                            <div style="display: flex; align-items: center; gap: 10px; margin: 8px 0; padding: 8px; background: var(--bg-tertiary); border-radius: 6px;">
                                <span style="font-size: 1.5em;">${pc.iconType === 'image' ? `<img src="${pc.icon}" style="max-height: 30px; width: auto;">` : pc.icon}</span>
                                <div>
                                    <div style="font-weight: 600;">${pc.name}</div>
                                    ${wizardConfig.hardware.hasSwitch ? `<div style="font-size: 0.85em; color: var(--text-secondary);">Port ${pc.port}</div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid #ff6b35;">
                        <h3 style="margin: 0 0 10px 0; color: #ff6b35;"> Appearance</h3>
                        <p style="margin: 5px 0;"><strong>Dashboard Title:</strong> ${wizardConfig.appearance.dashboardTitle}</p>
                        <p style="margin: 5px 0;"><strong>Theme:</strong> ${themeName.charAt(0).toUpperCase() + themeName.slice(1)}</p>
                        <p style="margin: 5px 0;"><strong>Mode:</strong> ${mode === 'dark' ? ' Dark' : ' Light'}</p>
                        ${wizardConfig.appearance.theme === 'custom' ? `
                            <div style="margin-top: 10px;">
                                <strong>Custom Colors (${mode}):</strong>
                                <div style="display: flex; gap: 10px; margin-top: 5px; flex-wrap: wrap;">
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <span style="display:inline-block;width:20px;height:20px;background:${mode === 'light' ? wizardConfig.appearance.customColors.light.cardTitle : wizardConfig.appearance.customColors.dark.cardTitle};border-radius:4px;border:1px solid var(--border-color);"></span>
                                        <span style="font-size: 0.85em;">Card Title</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <span style="display:inline-block;width:20px;height:20px;background:${mode === 'light' ? wizardConfig.appearance.customColors.light.cardBg : wizardConfig.appearance.customColors.dark.cardBg};border-radius:4px;border:1px solid var(--border-color);"></span>
                                        <span style="font-size: 0.85em;">Card Background</span>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid #ff6b35;">
                        <h3 style="margin: 0 0 10px 0; color: #ff6b35;"> Features Enabled</h3>
                        <div class="review-features-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                            ${Object.entries(wizardConfig.features).filter(([k,v]) => v).map(([key,val]) => `
                                <div style="padding: 6px 10px; background: var(--bg-tertiary); border-radius: 6px; font-size: 0.9em;">
                                     ${key.replace(/([A-Z])/g, ' $1').trim().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; border-left: 4px solid #ff6b35;">
                        <h3 style="margin: 0 0 10px 0; color: #ff6b35;"> Advanced Settings</h3>
                        <p style="margin: 5px 0;"><strong>Status Check Interval:</strong> ${(wizardConfig.advanced.statusCheckInterval / 1000)} seconds</p>
                        <p style="margin: 5px 0;"><strong>Action Log Limit:</strong> ${wizardConfig.advanced.actionLogLimit} items</p>
                        <p style="margin: 5px 0;"><strong>Require Confirmation:</strong> ${wizardConfig.advanced.requireConfirmation ? 'Yes' : 'No'}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('wizardBody').innerHTML = `
                <div class="wizard-step active">
                    <h2>Review & Finish</h2>
                    <p>Review your configuration before saving</p>
                    <div style="padding-right: 10px;">
                        ${summary}
                    </div>
                </div>
            `;
        }
        
        async function finishWizard() {
            // Ensure all config is complete
            if (!wizardConfig.appearance) {
                wizardConfig.appearance = {
                    theme: 'dark',
                    primaryColor: '#ff6b35',
                    secondaryColor: '#ff8c00',
                    backgroundColor: '#1e1e1e',
                    backgroundImage: '',
                    logo: '/logo.png',
                    dashboardTitle: 'Control Dashboard'
                };
            }
            
            if (!wizardConfig.features) {
                wizardConfig.features = {
                    keyboardShortcuts: true,
                    scheduledActions: true,
                    idleShutdown: true,
                    actionLog: true,
                    uptimeTracking: true,
                    soundNotifications: true,
                    hddActivity: true
                };
            }
            
            if (!wizardConfig.advanced) {
                wizardConfig.advanced = {
                    statusCheckInterval: 30000,
                    hddCheckInterval: 1000,
                    actionLogLimit: 100,
                    requireConfirmation: true,
                    safeMode: false,
                    customCSS: ''
                };
            }
            
            // Mark as no longer first run
            wizardConfig.version = '1.0';
            wizardConfig.firstRun = false;
            
            console.log('Saving config:', wizardConfig);
            
            // Save configuration
            const result = await apiRequest('/config', 'POST', wizardConfig);
            
            console.log('Save result:', result);
            
            if (result && result.success) {
                showToast('Configuration saved! Loading dashboard...', 'success');
                document.getElementById('setupWizard').classList.remove('show');
                
                // Reload page to apply new config
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast('Failed to save configuration. Check console for details.', 'error');
                console.error('Config save failed:', result);
            }
        }
        
        async function saveSettings() {
            // Capture current values from whichever step we're on
            // Step 2: PC configuration
            if (wizardCurrentStep === 2) {
                if (!validatePCConfig()) {
                    return; // Validation failed
                }
            }
            // Other steps auto-update wizardConfig as user makes changes
            
            // Save current wizard config (from settings mode)
            console.log('Saving settings:', wizardConfig);
            
            // Save configuration
            const result = await apiRequest('/config', 'POST', wizardConfig);
            
            console.log('Save result:', result);
            
            if (result && result.success) {
                showToast('Settings saved! Reloading dashboard...', 'success');
                
                // Close wizard and reload
                document.getElementById('setupWizard').classList.remove('show');
                isSettingsMode = false; // Reset settings mode flag
                
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showToast('Failed to save settings. Check console for details.', 'error');
                console.error('Settings save failed:', result);
            }
        }
        
        // Custom Confirmation Dialog
        let confirmResolve = null;
        
        function showConfirmDialog(title, message) {
            return new Promise((resolve) => {
                confirmResolve = resolve;
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').textContent = message;
                document.getElementById('confirmDialog').classList.add('show');
            });
        }
        
        function closeConfirmDialog(result) {
            document.getElementById('confirmDialog').classList.remove('show');
            if (confirmResolve) {
                confirmResolve(result);
                confirmResolve = null;
            }
        }
        
        async function skipWizard() {
            // Show custom confirmation dialog
            const confirmed = await showConfirmDialog(
                ' Skip Setup',
                'Are you sure you want to exit the setup wizard? Your current configuration will be kept, but any unsaved changes will be lost.'
            );
            
            if (confirmed) {
                // Just close wizard without saving - keeps existing config
                document.getElementById('setupWizard').classList.remove('show');
            }
        }
        
        async function openSettings() {
            // Load custom images before showing wizard
            await loadCustomImages();
            
            // Load current config into wizard
            wizardConfig = window.dashboardConfig || {};
            wizardCurrentStep = 1;
            isSettingsMode = true; // Enable settings mode for free navigation
            buildWizardStep1();
            updateWizardProgress();
            document.getElementById('setupWizard').classList.add('show');
        }

        async function runSetupWizard() {
            // Manually trigger setup wizard (for re-running setup from scratch)
            await showSetupWizard();
        }
        
        // ============ API HELPER FUNCTIONS ============
        
        async function apiRequest(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data && method !== 'GET') {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                return null;
            }
        }
        
        async function loadPreferences() {
            const prefs = await apiRequest('/preferences');
            if (prefs) {
                soundEnabled = prefs.soundEnabled !== false;
                theme = prefs.theme || 'dark';
                advancedFeaturesExpanded = prefs.advancedFeaturesExpanded === true;
                
                // Update UI
                document.documentElement.setAttribute('data-theme', theme);
                updateThemeButton();
                updateSoundButton();
                
                // Load idle settings
                if (prefs.idleEnabled) {
                    for (let port = 0; port < 2; port++) {
                        document.getElementById(`idle-enabled-${port}`).checked = prefs.idleEnabled[port] || false;
                        document.getElementById(`idle-minutes-${port}`).value = prefs.idleMinutes?.[port] || 30;
                        updateIdleStatus(port, prefs.idleEnabled[port] || false);
                    }
                }
            }
        }
        
        async function savePreferences() {
            const prefs = {
                soundEnabled: soundEnabled,
                theme: theme,
                advancedFeaturesExpanded: advancedFeaturesExpanded,
                idleEnabled: [
                    document.getElementById('idle-enabled-0').checked,
                    document.getElementById('idle-enabled-1').checked
                ],
                idleMinutes: [
                    parseInt(document.getElementById('idle-minutes-0').value) || 30,
                    parseInt(document.getElementById('idle-minutes-1').value) || 30
                ]
            };
            
            await apiRequest('/preferences', 'POST', prefs);
        }
        
        async function loadActionLog() {
            const data = await apiRequest('/actions');
            if (data && data.actions) {
                // Check for new scheduled actions to notify about
                if (notificationsEnabled && lastSeenActionTime && data.actions.length > 0) {
                    const newActions = data.actions.filter(action => {
                        const actionTime = new Date(action.timestamp).getTime();
                        return actionTime > lastSeenActionTime && action.method === 'scheduled';
                    });
                    
                    newActions.forEach(action => {
                        showNotification(action);
                    });
                }
                
                // Update last seen time
                if (data.actions.length > 0) {
                    lastSeenActionTime = new Date(data.actions[0].timestamp).getTime();
                }
                
                actionLog = data.actions;
                renderActionLog();
            }
        }
        
        async function loadScheduledActions() {
            const data = await apiRequest('/schedules');
            if (data && data.schedules) {
                scheduledActions = data.schedules;
                renderScheduledActions();
            }
        }
        
        // Load config from localStorage
        let config = {
            url: localStorage.getItem('pikvm_url') || '',
            username: localStorage.getItem('pikvm_username') || 'admin',
            password: localStorage.getItem('pikvm_password') || ''
        };

        // Initialize
        window.addEventListener('DOMContentLoaded', async function() {
            console.log('DOMContentLoaded event fired');
            
            // Apply theme immediately from localStorage before API loads
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            console.log('Theme applied:', savedTheme);
            
            // Check authentication
            console.log('Checking authentication...');
            let isAuthenticated = await checkAuth();
            console.log('Authentication status:', isAuthenticated);
            
            // If not authenticated and we have embedded credentials, try auto-login
            if (!isAuthenticated && EMBEDDED_USERNAME !== 'PIKVM_USERNAME_PLACEHOLDER') {
                console.log('Attempting auto-login...');
                isAuthenticated = await autoLogin();
                
                if (!isAuthenticated) {
                    // Auto-login failed, show manual login modal
                    console.log('Auto-login failed, showing login modal');
                    document.getElementById('loginModal').style.display = 'flex';
                    return;
                }
            } else if (!isAuthenticated) {
                // No embedded credentials, show login modal
                console.log('No credentials, showing login modal');
                document.getElementById('loginModal').style.display = 'flex';
                return;
            }
            
            console.log('Authentication successful');
            
            // Check for fresh install and reset notification settings if needed (after auth)
            try {
                const response = await fetch('/api/dashboard/fresh-install-timestamp');
                if (response.ok) {
                    const data = await response.json();
                    console.log('Fresh install timestamp from server:', data.timestamp);
                    console.log('Stored timestamp in localStorage:', localStorage.getItem('fresh_install_timestamp'));
                    if (data.timestamp) {
                        const storedTimestamp = localStorage.getItem('fresh_install_timestamp');
                        if (storedTimestamp !== data.timestamp) {
                            // Fresh install detected - reset notifications to OFF
                            console.log('Fresh install detected, resetting notification settings');
                            localStorage.setItem('notifications_enabled', 'false');
                            notificationsEnabled = false;
                            localStorage.setItem('fresh_install_timestamp', data.timestamp);
                            // Update UI immediately
                            setTimeout(() => updateMenuNotifyText(), 0);
                        }
                    }
                }
            } catch (e) {
                console.log('Could not check fresh install timestamp:', e);
            }
            
            // Check if this is first run
            console.log('Checking first run status...');
            const isFirstRun = await checkFirstRun();
            console.log('First run status:', isFirstRun);
            
            if (isFirstRun) {
                // Show setup wizard
                console.log('First run detected, showing setup wizard');
                await showSetupWizard();
                return;
            }
            
            // User is authenticated and configured, initialize dashboard
            console.log('Initializing dashboard...');
            await initDashboard();
            
            // Set min datetime to now
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const schedTimeEl = document.getElementById('schedule-time');
            if (schedTimeEl) schedTimeEl.min = now.toISOString().slice(0, 16);
            
            const configSection = document.getElementById('config-section');
            if (configSection) configSection.classList.add('hidden');
            
            const showConfigBtn = document.getElementById('show-config-btn');
            if (showConfigBtn) showConfigBtn.style.display = 'none';
            
            // Initialize advanced features state
            if (advancedFeaturesExpanded) {
                const sections = document.querySelectorAll('.advanced-feature');
                sections.forEach(section => section.classList.add('show'));
                const arrow = document.getElementById('toggle-arrow');
                const text = document.getElementById('toggle-text');
                if (arrow) arrow.classList.add('expanded');
                if (text) text.textContent = 'Hide Advanced Features';
            }
            
            // Initialize notification toggle state in menu
            updateMenuNotifyText();
            
            // Enable shortcut buttons when PC is selected
            const shortcutSelector = document.getElementById('shortcut-pc-selector');
            if (shortcutSelector) {
                shortcutSelector.addEventListener('change', function(e) {
                    const buttons = document.querySelectorAll('.shortcut-btn');
                    const enabled = e.target.value !== '';
                    buttons.forEach(btn => btn.disabled = !enabled);
                });
            }
        });

        function toggleTheme() {
            // Toggle the mode in the config
            if (window.dashboardConfig && window.dashboardConfig.appearance) {
                const currentMode = window.dashboardConfig.appearance.mode || 'dark';
                const newMode = currentMode === 'dark' ? 'light' : 'dark';
                
                // Update the config
                window.dashboardConfig.appearance.mode = newMode;
                
                // Store in localStorage for instant load
                localStorage.setItem('dashboardMode', newMode);
                
                // Re-apply appearance with new mode
                applyAppearance(window.dashboardConfig.appearance);
                
                // Update button text
                updateThemeButton(newMode);
                
                // Save to backend
                saveConfig(window.dashboardConfig);
            }
        }

        function updateThemeButton(mode = null) {
            const btn = document.getElementById('themeToggle');
            if (!btn) return;
            
            const currentMode = mode || (window.dashboardConfig?.appearance?.mode) || 'dark';
            btn.textContent = currentMode === 'dark' ? ' Light' : ' Dark';
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('soundEnabled', soundEnabled); // Backup in localStorage for instant load
            updateSoundButton();
            savePreferences();
            if (soundEnabled) {
                playSound('success');
            }
        }

        function updateSoundButton() {
            const btn = document.getElementById('soundToggle');
            if (btn) btn.textContent = soundEnabled ? ' Sound On' : ' Sound Off';
        }

        // Hamburger Menu Functions
        function toggleMenu() {
            console.log('toggleMenu called');
            const menu = document.getElementById('menuOverlay');
            console.log('Menu element:', menu);
            if (!menu) {
                console.error('menuOverlay element not found!');
                return;
            }
            menu.classList.toggle('show');
            console.log('Menu show state:', menu.classList.contains('show'));
            
            // Update menu text when opening
            if (menu.classList.contains('show')) {
                updateMenuThemeText();
                updateMenuSoundText();
                updateMenuNotifyText();
                updateMenuAdvancedText();
            }
        }

        function closeMenuOnOverlayClick(event) {
            // Only close if clicking on the overlay itself, not the menu content
            if (event.target.id === 'menuOverlay') {
                toggleMenu();
            }
        }

        function updateMenuThemeText() {
            const mode = window.dashboardConfig?.appearance?.mode || 'dark';
            const icon = document.getElementById('menuThemeIcon');
            const text = document.getElementById('menuThemeText');
            const toggle = document.getElementById('menuThemeToggle');
            if (icon && text) {
                icon.textContent = mode === 'dark' ? '' : '';
                text.textContent = mode === 'dark' ? 'Light Mode' : 'Dark Mode';
            }
            if (toggle) {
                toggle.checked = mode === 'light';
            }
        }

        function updateMenuSoundText() {
            const icon = document.getElementById('menuSoundIcon');
            const text = document.getElementById('menuSoundText');
            const toggle = document.getElementById('menuSoundToggle');
            if (icon && text) {
                icon.textContent = soundEnabled ? '' : '';
                text.textContent = soundEnabled ? 'Sound On' : 'Sound Off';
            }
            if (toggle) {
                toggle.checked = soundEnabled;
            }
        }

        function updateMenuAdvancedText() {
            const text = document.getElementById('menuAdvancedText');
            const toggle = document.getElementById('menuAdvancedToggle');
            if (text) {
                text.textContent = advancedFeaturesExpanded ? 'Hide Advanced' : 'Show Advanced';
            }
            if (toggle) {
                toggle.checked = advancedFeaturesExpanded;
            }
        }

        // Navigation functions
        function navigateToKVM() {
            window.location.href = '/kvm/';
        }

        function navigateToTerminal() {
            window.location.href = '/extras/webterm/ttyd/';
        }

        function navigateToVNC() {
            window.location.href = '/vnc/';
        }

        function logoutPiKVM() {
            // Clear session and redirect to login
            fetch('/api/auth/logout', {
                method: 'POST',
                credentials: 'same-origin'
            }).then(() => {
                window.location.href = '/';
            }).catch(() => {
                // Even if logout fails, redirect anyway
                window.location.href = '/';
            });
        }

        function toggleAdvancedFeatures() {
            advancedFeaturesExpanded = !advancedFeaturesExpanded;
            localStorage.setItem('advancedFeaturesExpanded', advancedFeaturesExpanded); // Backup in localStorage
            savePreferences();
            
            const arrow = document.getElementById('toggle-arrow');
            const text = document.getElementById('toggle-text');
            const toggleButton = document.querySelector('.toggle-features');
            const showConfigBtn = document.getElementById('show-config-btn');
            
            // Toggle each section individually
            const sections = document.querySelectorAll('.advanced-feature');
            
            if (advancedFeaturesExpanded) {
                sections.forEach(section => section.classList.add('show'));
                arrow.classList.add('expanded');
                text.textContent = 'Hide Advanced Features';
                
                // Scroll to the toggle button smoothly after a short delay to allow animation to start
                setTimeout(() => {
                    toggleButton.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            } else {
                sections.forEach(section => section.classList.remove('show'));
                arrow.classList.remove('expanded');
                text.textContent = 'Show Advanced Features';
                
                // Hide show config button when collapsing
                if (showConfigBtn) {
                    showConfigBtn.style.display = 'none';
                }
            }
        }

        function playSound(type) {
            if (!soundEnabled) return;
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            if (type === 'success') {
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
            } else if (type === 'error') {
                oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime + 0.1);
            }
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        }

        // ============ KEYBOARD SHORTCUTS ============
        async function sendShortcut(shortcut) {
            const port = document.getElementById('shortcut-pc-selector').value;
            if (!port) {
                showToast('Please select a PC first', 'error');
                return;
            }

            const pcName = port === '0' ? 'MediaServer' : 'GamingPC';
            
            // Map shortcuts to PiKVM key codes (W3C KeyboardEvent.code values)
            // API endpoint: POST /api/hid/events/send_shortcut?keys=Key1,Key2,...
            const shortcuts = {
                'ctrl-alt-del': 'ControlLeft,AltLeft,Delete',
                'ctrl-alt-esc': 'ControlLeft,AltLeft,Escape',
                'alt-f4': 'AltLeft,F4',
                'win': 'MetaLeft',
                'win-r': 'MetaLeft,KeyR',
                'win-l': 'MetaLeft,KeyL'
            };

            const keySequence = shortcuts[shortcut];
            if (!keySequence) return;

            const config = window.dashboardConfig;
            const hasSwitch = config && config.hardware && config.hardware.hasSwitch;

            try {
                // For Switch setups, switch to the target port first
                if (hasSwitch) {
                    await makeRequest(`/api/switch/set_active?port=${port}`, 'POST');
                    // Brief delay to let the switch complete
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // Send keyboard shortcut via HID events API
                await makeRequest(`/api/hid/events/send_shortcut?keys=${encodeURIComponent(keySequence)}`, 'POST');
                showToast(`Sent ${shortcut.toUpperCase()} to ${pcName}`, 'success');
                playSound('success');
                logAction(pcName, `Keyboard shortcut: ${shortcut.toUpperCase()}`, 'shortcut');
            } catch (error) {
                showToast('Failed to send shortcut', 'error');
                playSound('error');
            }
        }

        // ============ SCHEDULED ACTIONS ============
        async function addScheduledAction() {
            const port = document.getElementById('schedule-pc').value;
            const actionType = document.getElementById('schedule-action-type').value;
            const timeStr = document.getElementById('schedule-time').value;
            const isRecurring = document.getElementById('schedule-recurring').checked;
            
            if (!timeStr) {
                showToast('Please select a date and time', 'error');
                return;
            }
            
            const scheduledTime = new Date(timeStr);
            const now = new Date();
            
            if (scheduledTime <= now) {
                showToast('Please select a future time', 'error');
                return;
            }
            
            const pcName = port === '0' ? 'MediaServer' : 'GamingPC';
            const frequency = isRecurring ? document.getElementById('schedule-frequency').value : null;
            
            // Determine primary action
            let action, keyboardShortcut;
            if (actionType === 'keyboard') {
                action = 'keyboard';
                keyboardShortcut = document.getElementById('schedule-keyboard-shortcut').value;
            } else {
                action = document.getElementById('schedule-action').value;
            }
            
            // Build base schedule object
            const buildSchedule = () => {
                const condition = document.getElementById('schedule-condition').value;
                
                const schedule = {
                    port: parseInt(port),
                    action: action,
                    time: scheduledTime.getTime(),
                    pcName: pcName,
                    isRecurring: isRecurring,
                    followUpActions: [],
                    condition: condition
                };
                
                if (action === 'keyboard') {
                    schedule.keyboardShortcut = keyboardShortcut;
                }
                
                if (isRecurring) {
                    schedule.frequency = frequency;
                    
                    // For weekly/biweekly, store all selected days as array
                    if (frequency === 'weekly' || frequency === 'biweekly') {
                        const selectedDays = Array.from(document.querySelectorAll('.schedule-day-checkbox:checked'))
                            .map(cb => parseInt(cb.value));
                        schedule.daysOfWeek = selectedDays;
                    }
                }
                
                return schedule;
            };
            
            // Validate weekly/biweekly has days selected
            if (isRecurring && (frequency === 'weekly' || frequency === 'biweekly')) {
                const selectedDays = Array.from(document.querySelectorAll('.schedule-day-checkbox:checked'));
                
                if (selectedDays.length === 0) {
                    showToast('Please select at least one day of the week', 'error');
                    return;
                }
            }
            
            // Create single schedule (with days array for weekly/biweekly)
            await apiRequest('/schedules', 'POST', buildSchedule());
            
            const scheduleType = isRecurring ? 'Recurring schedule' : 'Scheduled action';
            showToast(`${scheduleType} added`, 'success');
            
            playSound('success');
            
            // Reload schedules
            await loadScheduledActions();
            
            // Clear inputs
            document.getElementById('schedule-time').value = '';
            document.getElementById('schedule-recurring').checked = false;
            
            // Uncheck all day checkboxes
            document.querySelectorAll('.schedule-day-checkbox').forEach(cb => cb.checked = false);
            
            // Hide options
            toggleRecurringOptions();
        }

        async function removeScheduledAction(id) {
            await apiRequest(`/schedules/${id}`, 'DELETE');
            selectedSchedules.delete(id); // Remove from selection if selected
            await loadScheduledActions();
            showToast('Scheduled action removed', 'info');
        }

        function toggleRecurringOptions() {
            const isRecurring = document.getElementById('schedule-recurring').checked;
            const recurringOptions = document.getElementById('recurring-options');
            
            if (isRecurring) {
                recurringOptions.style.display = 'block';
                toggleDayOfWeekSelector(); // Check if day selector should be shown
            } else {
                recurringOptions.style.display = 'none';
            }
        }

        function toggleDayOfWeekSelector() {
            const frequency = document.getElementById('schedule-frequency').value;
            const daySelector = document.getElementById('day-of-week-selector');
            
            if (frequency === 'weekly' || frequency === 'biweekly') {
                daySelector.style.display = 'block';
            } else {
                daySelector.style.display = 'none';
            }
        }

        function toggleActionOptions() {
            const actionType = document.getElementById('schedule-action-type').value;
            const powerSelect = document.getElementById('schedule-action');
            const keyboardSelect = document.getElementById('schedule-keyboard-shortcut');
            
            if (actionType === 'power') {
                powerSelect.style.display = 'block';
                keyboardSelect.style.display = 'none';
            } else {
                powerSelect.style.display = 'none';
                keyboardSelect.style.display = 'block';
            }
        }

        function renderScheduledActions() {
            const listEl = document.getElementById('schedule-list');
            const emptyMsg = document.getElementById('schedule-empty-message');
            
            if (scheduledActions.length === 0) {
                listEl.innerHTML = '';
                listEl.style.minHeight = '0';
                if (emptyMsg) emptyMsg.style.display = 'block';
                return;
            }
            
            if (emptyMsg) emptyMsg.style.display = 'none';
            listEl.style.minHeight = '240px';
            const now = Date.now();
            
            listEl.innerHTML = scheduledActions.map(schedule => {
                const timeLeft = schedule.time - now;
                const hours = Math.floor(timeLeft / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                
                // Format action text
                let actionText;
                if (schedule.action === 'keyboard') {
                    const shortcutMap = {
                        'ctrl-alt-del': 'Ctrl+Alt+Del',
                        'ctrl-alt-esc': 'Ctrl+Alt+Esc',
                        'alt-f4': 'Alt+F4',
                        'win': 'Win Key',
                        'win-r': 'Win+R',
                        'win-l': 'Win+L'
                    };
                    actionText = ` ${shortcutMap[schedule.keyboardShortcut] || schedule.keyboardShortcut}`;
                } else {
                    actionText = schedule.action === 'on' ? 'Power On' : 
                                 schedule.action === 'off' ? 'Power Off' : 'Reset';
                }
                
                // Format secondary action if present
                let secondaryText = '';
                if (schedule.hasSecondaryAction) {
                    const delayMap = {seconds: 's', minutes: 'm', hours: 'h', days: 'd'};
                    const delayUnit = delayMap[schedule.secondaryDelayUnit] || 's';
                    
                    let secondaryAction;
                    if (schedule.secondaryAction === 'keyboard') {
                        const shortcutMap = {
                            'ctrl-alt-del': 'Ctrl+Alt+Del',
                            'ctrl-alt-esc': 'Ctrl+Alt+Esc',
                            'alt-f4': 'Alt+F4',
                            'win': 'Win',
                            'win-r': 'Win+R',
                            'win-l': 'Win+L'
                        };
                        secondaryAction = shortcutMap[schedule.secondaryKeyboardShortcut] || schedule.secondaryKeyboardShortcut;
                    } else {
                        secondaryAction = schedule.secondaryAction === 'on' ? 'Power On' :
                                         schedule.secondaryAction === 'off' ? 'Power Off' : 'Reset';
                    }
                    
                    secondaryText = `<div style="margin-top: 4px; font-size: 12px; color: var(--text-secondary);">
                         Then: ${secondaryAction} (after ${schedule.secondaryDelay}${delayUnit})
                    </div>`;
                }
                
                // Format frequency text
                let frequencyText = '';
                if (schedule.isRecurring) {
                    const freqMap = {
                        'daily': 'Daily',
                        'weekly': 'Weekly',
                        'biweekly': 'Bi-weekly',
                        'monthly': 'Monthly',
                        'quarterly': 'Quarterly',
                        'annually': 'Annually'
                    };
                    frequencyText = freqMap[schedule.frequency] || schedule.frequency;
                    
                    // Add days for weekly/biweekly (display all selected days)
                    if (schedule.frequency === 'weekly' || schedule.frequency === 'biweekly') {
                        const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                        const daysOfWeek = schedule.daysOfWeek || (schedule.dayOfWeek !== undefined ? [schedule.dayOfWeek] : []);
                        
                        if (daysOfWeek.length > 0) {
                            const dayLabels = daysOfWeek.map(d => dayNames[d]).join(', ');
                            frequencyText += ` (${dayLabels})`;
                        }
                    }
                }
                
                return `
                    <div class="schedule-item" style="${schedule.isRecurring ? 'border-left: 3px solid #ff9800;' : ''} display: flex; align-items: flex-start; gap: 10px;">
                        <input type="checkbox" 
                               class="schedule-checkbox" 
                               data-schedule-id="${schedule.id}"
                               ${selectedSchedules.has(schedule.id) ? 'checked' : ''}
                               onchange="toggleScheduleSelection(${schedule.id})"
                               style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent-color);">
                        <div class="schedule-info" style="flex: 1;">
                            ${schedule.isRecurring ? 
                                `<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                    <span style="background: rgba(255, 152, 0, 0.2); color: #ff9800; padding: 2px 8px; border-radius: 3px; font-size: 11px; font-weight: 600;"> RECURRING</span>
                                    <span style="color: var(--text-secondary); font-size: 12px;">${frequencyText}</span>
                                </div>` : ''
                            }
                            <div class="schedule-time">${new Date(schedule.time).toLocaleString()}</div>
                            <div class="schedule-details">${schedule.pcName} - ${actionText}</div>
                            ${schedule.condition && schedule.condition !== 'always' ? `
                                <div style="margin-top: 4px;">
                                    <span style="background: ${schedule.condition === 'smart' ? 'rgba(76, 175, 80, 0.2)' : 'rgba(33, 150, 243, 0.2)'}; 
                                                 color: ${schedule.condition === 'smart' ? '#4CAF50' : '#2196F3'}; 
                                                 padding: 2px 8px; border-radius: 3px; font-size: 10px; font-weight: 500;">
                                         ${schedule.condition === 'smart' ? 'Smart' : schedule.condition === 'if_off' ? 'Only if OFF' : 'Only if ON'}
                                    </span>
                                </div>
                            ` : ''}
                            ${secondaryText}
                            
                            ${schedule.followUpActions && schedule.followUpActions.length > 0 ? 
                                `<div class="followup-container" data-schedule-id="${schedule.id}">` +
                                schedule.followUpActions.map((followUp, idx) => {
                                    const delayMap = {seconds: 's', minutes: 'm', hours: 'h', days: 'd'};
                                    const delayUnit = delayMap[followUp.delayUnit] || 's';
                                    
                                    let followUpAction;
                                    if (followUp.action === 'keyboard') {
                                        const shortcutMap = {
                                            'ctrl-alt-del': 'Ctrl+Alt+Del',
                                            'ctrl-alt-esc': 'Ctrl+Alt+Esc',
                                            'alt-f4': 'Alt+F4',
                                            'win': 'Win',
                                            'win-r': 'Win+R',
                                            'win-l': 'Win+L'
                                        };
                                        followUpAction = ' ' + (shortcutMap[followUp.keyboardShortcut] || followUp.keyboardShortcut);
                                    } else {
                                        followUpAction = followUp.action === 'on' ? 'Power On' :
                                                        followUp.action === 'off' ? 'Power Off' : 'Reset';
                                    }
                                    
                                    return `<div class="followup-item" draggable="true" data-index="${idx}" 
                                                 ondragstart="handleFollowUpDragStart(event, ${schedule.id}, ${idx})"
                                                 ondragover="handleFollowUpDragOver(event)"
                                                 ondrop="handleFollowUpDrop(event, ${schedule.id}, ${idx})"
                                                 ondragend="handleFollowUpDragEnd(event)"
                                                 style="margin-top: 4px; font-size: 12px; color: var(--text-secondary); padding: 6px 12px; border-left: 2px solid rgba(255, 152, 0, 0.3); display: flex; align-items: center; gap: 8px; cursor: grab; background: var(--card-bg); border-radius: 0 4px 4px 0; transition: background 0.2s;">
                                        <span class="drag-handle" style="color: var(--text-secondary); opacity: 0.5; font-size: 14px;"></span>
                                        <span style="flex: 1;"> Then: ${followUpAction} (after ${followUp.delay}${delayUnit})</span>
                                        <button onclick="removeFollowUp(${schedule.id}, ${idx}); event.stopPropagation();" style="background: none; border: none; color: #ff6b35; cursor: pointer; font-size: 11px; padding: 2px 6px;"></button>
                                    </div>`;
                                }).join('') + `</div>` : ''
                            }
                            
                            ${timeLeft > 0 ? `<div class="schedule-countdown">In ${hours}h ${minutes}m</div>` : ''}
                            <button class="btn-add-followup" onclick="showAddFollowUpModal(${schedule.id})" style="margin-top: 8px; padding: 4px 8px; font-size: 11px; background: rgba(255, 152, 0, 0.2); color: #ff9800; border: 1px solid #ff9800; border-radius: 4px; cursor: pointer;">
                                 Add Follow-up
                            </button>
                        </div>
                        <button class="btn-remove" onclick="removeScheduledAction(${schedule.id})">Remove</button>
                    </div>
                `;
            }).join('');
            
            // Update bulk actions bar visibility
            updateBulkActionsBar();
            
            // Also refresh calendar if it's visible
            if (currentScheduleView === 'calendar') {
                renderCalendar();
            }
        }

        function startScheduleChecking() {
            // Just reload schedules periodically - server handles execution
            scheduleCheckInterval = setInterval(async () => {
                await loadScheduledActions();
                await loadActionLog(); // Also refresh action log to show scheduled actions
            }, 5000); // Check every 5 seconds
        }

        // ============ BULK SCHEDULE OPERATIONS ============
        
        function toggleScheduleSelection(scheduleId) {
            if (selectedSchedules.has(scheduleId)) {
                selectedSchedules.delete(scheduleId);
            } else {
                selectedSchedules.add(scheduleId);
            }
            updateBulkActionsBar();
        }
        
        function selectAllSchedules() {
            scheduledActions.forEach(schedule => {
                selectedSchedules.add(schedule.id);
            });
            renderScheduledActions();
        }
        
        function deselectAllSchedules() {
            selectedSchedules.clear();
            renderScheduledActions();
        }
        
        function updateBulkActionsBar() {
            const bar = document.getElementById('bulk-actions-bar');
            const countEl = document.getElementById('selected-count');
            
            if (selectedSchedules.size > 0) {
                bar.style.display = 'flex';
                countEl.textContent = `${selectedSchedules.size} selected`;
            } else {
                bar.style.display = 'none';
            }
        }
        
        async function deleteSelectedSchedules() {
            if (selectedSchedules.size === 0) return;
            
            const count = selectedSchedules.size;
            if (!confirm(`Are you sure you want to delete ${count} schedule${count > 1 ? 's' : ''}?`)) {
                return;
            }
            
            // Delete each selected schedule
            const deletePromises = Array.from(selectedSchedules).map(id => 
                fetch(`/api/dashboard/schedules/${id}`, { method: 'DELETE' })
            );
            
            try {
                await Promise.all(deletePromises);
                selectedSchedules.clear();
                await loadScheduledActions();
                console.log(`Deleted ${count} schedule(s)`);
            } catch (error) {
                console.error('Error deleting schedules:', error);
                alert('Failed to delete some schedules. Please try again.');
            }
        }

        // ============ CALENDAR VIEW ============
        let currentScheduleView = 'list';
        let calendarDate = new Date();
        
        function setScheduleView(view) {
            currentScheduleView = view;
            
            const listBtn = document.getElementById('view-list-btn');
            const calendarBtn = document.getElementById('view-calendar-btn');
            const listView = document.getElementById('schedule-list-view');
            const calendarView = document.getElementById('schedule-calendar-view');
            const bulkBar = document.getElementById('bulk-actions-bar');
            
            if (view === 'list') {
                listBtn.style.background = '#ff8c00';
                listBtn.style.color = 'white';
                calendarBtn.style.background = 'transparent';
                calendarBtn.style.color = 'var(--theme-text-color, var(--text-primary))';
                listView.style.display = 'block';
                calendarView.style.display = 'none';
                if (selectedSchedules.size > 0) {
                    bulkBar.style.display = 'flex';
                }
            } else {
                listBtn.style.background = 'transparent';
                listBtn.style.color = 'var(--theme-text-color, var(--text-primary))';
                calendarBtn.style.background = '#ff8c00';
                calendarBtn.style.color = 'white';
                listView.style.display = 'none';
                calendarView.style.display = 'block';
                bulkBar.style.display = 'none';
                renderCalendar();
            }
        }
        
        function changeCalendarMonth(delta) {
            calendarDate.setMonth(calendarDate.getMonth() + delta);
            renderCalendar();
        }
        
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const label = document.getElementById('calendar-month-label');
            
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            
            // Set month label
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            label.textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and total days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Build schedule map for this month
            const schedulesByDay = {};
            scheduledActions.forEach(schedule => {
                const scheduleDate = new Date(schedule.time);
                
                // For recurring schedules, we need to check which days they occur
                if (schedule.isRecurring) {
                    // Check each day of the month
                    for (let day = 1; day <= daysInMonth; day++) {
                        const checkDate = new Date(year, month, day);
                        if (doesScheduleOccurOnDate(schedule, checkDate)) {
                            const key = day;
                            if (!schedulesByDay[key]) schedulesByDay[key] = [];
                            schedulesByDay[key].push(schedule);
                        }
                    }
                } else {
                    // One-time schedule
                    if (scheduleDate.getFullYear() === year && scheduleDate.getMonth() === month) {
                        const key = scheduleDate.getDate();
                        if (!schedulesByDay[key]) schedulesByDay[key] = [];
                        schedulesByDay[key].push(schedule);
                    }
                }
            });
            
            // Build grid HTML
            let html = '';
            
            // Day headers
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                html += `<div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 8px; font-size: 12px;">${day}</div>`;
            });
            
            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                html += `<div style="padding: 8px;"></div>`;
            }
            
            // Days of month
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
                const hasSchedules = schedulesByDay[day] && schedulesByDay[day].length > 0;
                const scheduleCount = hasSchedules ? schedulesByDay[day].length : 0;
                
                const bgColor = isToday ? 'rgba(76, 175, 80, 0.2)' : (hasSchedules ? 'rgba(255, 152, 0, 0.15)' : 'var(--card-bg)');
                const border = isToday ? '2px solid #4CAF50' : (hasSchedules ? '1px solid rgba(255, 152, 0, 0.5)' : '1px solid var(--border-color)');
                const cursor = hasSchedules ? 'pointer' : 'default';
                
                html += `
                    <div onclick="${hasSchedules ? `showCalendarDayDetails(${year}, ${month}, ${day})` : ''}" 
                         style="background: ${bgColor}; border: ${border}; border-radius: 6px; padding: 8px; min-height: 50px; cursor: ${cursor}; transition: all 0.2s;">
                        <div style="font-weight: ${isToday ? '700' : '500'}; color: var(--text-primary); font-size: 14px;">${day}</div>
                        ${hasSchedules ? `
                            <div style="margin-top: 4px;">
                                <span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: 600;">${scheduleCount}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            grid.innerHTML = html;
            
            // Hide day details when changing months
            document.getElementById('calendar-day-details').style.display = 'none';
        }
        
        function doesScheduleOccurOnDate(schedule, date) {
            const scheduleTime = new Date(schedule.time);
            
            if (!schedule.isRecurring) {
                return scheduleTime.toDateString() === date.toDateString();
            }
            
            const frequency = schedule.frequency;
            const dayOfWeek = date.getDay(); // 0 = Sunday
            
            // Convert to our format (0 = Monday)
            const ourDayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            
            if (frequency === 'daily') {
                return true;
            } else if (frequency === 'weekly' || frequency === 'biweekly') {
                const daysOfWeek = schedule.daysOfWeek || [];
                return daysOfWeek.includes(ourDayOfWeek);
            } else if (frequency === 'monthly') {
                return scheduleTime.getDate() === date.getDate();
            } else if (frequency === 'quarterly') {
                const monthDiff = (date.getMonth() - scheduleTime.getMonth() + 12) % 12;
                return monthDiff % 3 === 0 && scheduleTime.getDate() === date.getDate();
            } else if (frequency === 'annually') {
                return scheduleTime.getMonth() === date.getMonth() && scheduleTime.getDate() === date.getDate();
            }
            
            return false;
        }
        
        function showCalendarDayDetails(year, month, day) {
            const detailsEl = document.getElementById('calendar-day-details');
            const date = new Date(year, month, day);
            
            // Find schedules for this day
            const daySchedules = scheduledActions.filter(schedule => doesScheduleOccurOnDate(schedule, date));
            
            if (daySchedules.length === 0) {
                detailsEl.style.display = 'none';
                return;
            }
            
            const dateStr = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            let html = `
                <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
                    <h4 style="margin: 0 0 12px 0; color: var(--text-primary);"> ${dateStr}</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
            `;
            
            daySchedules.forEach(schedule => {
                const time = new Date(schedule.time);
                const timeStr = time.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                
                let actionText;
                if (schedule.action === 'keyboard') {
                    const shortcutMap = {
                        'ctrl-alt-del': 'Ctrl+Alt+Del',
                        'ctrl-alt-esc': 'Ctrl+Alt+Esc',
                        'alt-f4': 'Alt+F4',
                        'win': 'Win Key',
                        'win-r': 'Win+R',
                        'win-l': 'Win+L'
                    };
                    actionText = ` ${shortcutMap[schedule.keyboardShortcut] || schedule.keyboardShortcut}`;
                } else {
                    actionText = schedule.action === 'on' ? ' Power On' : 
                                 schedule.action === 'off' ? ' Power Off' : ' Reset';
                }
                
                const recurringBadge = schedule.isRecurring ? 
                    `<span style="background: rgba(255, 152, 0, 0.2); color: #ff9800; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-left: 8px;"> ${schedule.frequency}</span>` : '';
                
                html += `
                    <div class="schedule-item-row" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-radius: 6px;">
                        <div>
                            <strong style="color: var(--text-primary);">${schedule.pcName}</strong>${recurringBadge}
                            <div style="font-size: 13px; color: var(--text-secondary); margin-top: 2px;">${timeStr} - ${actionText}</div>
                        </div>
                        <button onclick="removeScheduledAction(${schedule.id})" style="background: none; border: 1px solid #dc3545; color: #dc3545; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            detailsEl.innerHTML = html;
            detailsEl.style.display = 'block';
        }

        // ============ FOLLOW-UP ACTIONS ============
        let currentScheduleIdForFollowUp = null;

        function showAddFollowUpModal(scheduleId) {
            currentScheduleIdForFollowUp = scheduleId;
            document.getElementById('followUpModal').classList.add('show');
            
            // Reset form
            document.getElementById('followup-delay').value = '60';
            document.getElementById('followup-delay-unit').value = 'minutes';
            document.getElementById('followup-action-type').value = 'power';
            toggleFollowUpActionType();
            
            // Add click outside to close
            setTimeout(() => {
                const modal = document.getElementById('followUpModal');
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        closeFollowUpModal();
                    }
                };
            }, 100);
        }

        function closeFollowUpModal() {
            const modal = document.getElementById('followUpModal');
            modal.classList.remove('show');
            modal.onclick = null;
            currentScheduleIdForFollowUp = null;
        }

        function toggleFollowUpActionType() {
            const actionType = document.getElementById('followup-action-type').value;
            const powerOptions = document.getElementById('followup-power-options');
            const keyboardOptions = document.getElementById('followup-keyboard-options');
            
            if (actionType === 'power') {
                powerOptions.style.display = 'block';
                keyboardOptions.style.display = 'none';
            } else {
                powerOptions.style.display = 'none';
                keyboardOptions.style.display = 'block';
            }
        }

        async function addFollowUpAction() {
            if (!currentScheduleIdForFollowUp) return;
            
            const delay = parseInt(document.getElementById('followup-delay').value);
            const delayUnit = document.getElementById('followup-delay-unit').value;
            const actionType = document.getElementById('followup-action-type').value;
            
            const followUp = {
                delay: delay,
                delayUnit: delayUnit
            };
            
            if (actionType === 'keyboard') {
                followUp.action = 'keyboard';
                followUp.keyboardShortcut = document.getElementById('followup-keyboard-shortcut').value;
            } else {
                followUp.action = document.getElementById('followup-power-action').value;
            }
            
            try {
                await apiRequest(`/schedules/${currentScheduleIdForFollowUp}/followup`, 'POST', followUp);
                showToast('Follow-up action added', 'success');
                playSound('success');
                closeFollowUpModal();
                await loadScheduledActions();
            } catch (error) {
                showToast('Failed to add follow-up action', 'error');
                playSound('error');
            }
        }

        async function removeFollowUp(scheduleId, followUpIndex) {
            try {
                await apiRequest(`/schedules/${scheduleId}/followup/${followUpIndex}`, 'DELETE');
                showToast('Follow-up removed', 'info');
                await loadScheduledActions();
            } catch (error) {
                showToast('Failed to remove follow-up', 'error');
            }
        }

        // ============ FOLLOW-UP DRAG AND DROP ============
        let draggedFollowUpData = null;
        
        function handleFollowUpDragStart(event, scheduleId, index) {
            draggedFollowUpData = { scheduleId, index };
            event.target.style.opacity = '0.5';
            event.target.style.cursor = 'grabbing';
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', ''); // Required for Firefox
        }
        
        function handleFollowUpDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            // Add visual indicator
            const target = event.target.closest('.followup-item');
            if (target) {
                target.style.background = 'rgba(255, 152, 0, 0.1)';
            }
        }
        
        function handleFollowUpDragEnd(event) {
            event.target.style.opacity = '1';
            event.target.style.cursor = 'grab';
            
            // Remove all drag-over styles
            document.querySelectorAll('.followup-item').forEach(item => {
                item.style.background = '';
            });
            
            draggedFollowUpData = null;
        }
        
        async function handleFollowUpDrop(event, targetScheduleId, targetIndex) {
            event.preventDefault();
            
            // Remove visual indicator
            const target = event.target.closest('.followup-item');
            if (target) {
                target.style.background = '';
            }
            
            if (!draggedFollowUpData) return;
            
            const { scheduleId: sourceScheduleId, index: sourceIndex } = draggedFollowUpData;
            
            // Only allow reordering within the same schedule
            if (sourceScheduleId !== targetScheduleId) {
                showToast('Can only reorder within same schedule', 'error');
                return;
            }
            
            // Don't do anything if dropped on itself
            if (sourceIndex === targetIndex) return;
            
            try {
                await reorderFollowUps(sourceScheduleId, sourceIndex, targetIndex);
                showToast('Follow-up order updated', 'success');
            } catch (error) {
                showToast('Failed to reorder follow-ups', 'error');
            }
        }
        
        async function reorderFollowUps(scheduleId, fromIndex, toIndex) {
            const response = await fetch(`/api/dashboard/schedules/${scheduleId}/followup/reorder`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fromIndex, toIndex })
            });
            
            if (!response.ok) {
                throw new Error('Failed to reorder');
            }
            
            await loadScheduledActions();
        }

        // ============ IDLE SHUTDOWN ============
        function toggleIdleShutdown(port) {
            const enabled = document.getElementById(`idle-enabled-${port}`).checked;
            const minutes = parseInt(document.getElementById(`idle-minutes-${port}`).value) || 30;
            
            if (enabled) {
                lastActivityTime[port] = Date.now();
                showToast('Idle shutdown enabled', 'success');
            } else {
                showToast('Idle shutdown disabled', 'info');
            }
            
            updateIdleStatus(port, enabled);
            savePreferences();
        }

        function updateIdleStatus(port, enabled) {
            const statusEl = document.getElementById(`idle-status-${port}`);
            const minutes = parseInt(document.getElementById(`idle-minutes-${port}`).value) || 30;
            
            if (enabled) {
                statusEl.textContent = `Active - ${minutes} min idle`;
                statusEl.classList.add('active');
            } else {
                statusEl.textContent = 'Disabled';
                statusEl.classList.remove('active');
            }
        }

        async function startIdleMonitoring() {
            setInterval(async () => {
                for (let port = 0; port < 2; port++) {
                    const enabled = document.getElementById(`idle-enabled-${port}`).checked;
                    if (!enabled) continue;
                    
                    const minutes = parseInt(document.getElementById(`idle-minutes-${port}`).value) || 30;
                    const idleThreshold = minutes * 60 * 1000; // Convert to milliseconds
                    
                    // Check PC status
                    const data = await makeRequest('/api/switch', 'GET');
                    if (!data) continue;
                    
                    const powerArray = data.result?.atx?.leds?.power;
                    const hddArray = data.result?.atx?.leds?.hdd;
                    const isOn = powerArray?.[port] === true;
                    const hddActive = hddArray?.[port] === true;
                    
                    // If PC is on
                    if (isOn) {
                        // If HDD is active, reset idle timer
                        if (hddActive) {
                            lastActivityTime[port] = Date.now();
                        } else {
                            // Check if idle time exceeded
                            const idleTime = Date.now() - (lastActivityTime[port] || Date.now());
                            
                            if (idleTime >= idleThreshold) {
                                const pcName = port === 0 ? 'MediaServer' : 'GamingPC';
                                console.log(`${pcName} idle for ${Math.floor(idleTime / 60000)} minutes, shutting down...`);
                                
                                await makeRequest(`/api/switch/atx/click?port=${port}&button=power`);
                                showToast(`${pcName} auto-shutdown (idle)`, 'info');
                                playSound('success');
                                logAction(pcName, `Auto-shutdown after ${minutes} min idle`, 'auto-shutdown');
                                
                                // Reset timer
                                lastActivityTime[port] = Date.now();
                            }
                        }
                    } else {
                        // PC is off, reset timer
                        lastActivityTime[port] = Date.now();
                    }
                }
            }, 30000); // Check every 30 seconds
        }

        // ============ EXISTING FUNCTIONS ============
        async function logAction(pcName, action, method) {
            const logEntry = {
                pcName,
                action,
                method,
                timestamp: new Date().toLocaleString()
            };
            
            // Save to API
            await apiRequest('/actions', 'POST', logEntry);
            
            // Reload action log
            await loadActionLog();
        }

        function renderActionLog() {
            const logContainer = document.getElementById('actionLog');
            
            if (actionLog.length === 0) {
                logContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No recent actions</div>';
                return;
            }
            
            logContainer.innerHTML = actionLog.map(entry => {
                const isSkipped = entry.action.toLowerCase().includes('skipped');
                
                let actionClass = 'power-on';
                if (entry.action.toLowerCase().includes('shutdown') || entry.action.toLowerCase().includes('off')) {
                    actionClass = 'shutdown';
                } else if (entry.action.toLowerCase().includes('reset') || entry.action.toLowerCase().includes('restart')) {
                    actionClass = 'reset';
                }
                
                // Show method badge for scheduled actions
                let methodBadge = '';
                if (entry.method === 'scheduled') {
                    if (isSkipped) {
                        methodBadge = '<span style="background: rgba(158, 158, 158, 0.2); color: #9e9e9e; padding: 1px 6px; border-radius: 3px; font-size: 10px; margin-left: 6px;"> Skipped</span>';
                    } else {
                        methodBadge = '<span style="background: rgba(255, 152, 0, 0.2); color: #ff9800; padding: 1px 6px; border-radius: 3px; font-size: 10px; margin-left: 6px;"> Scheduled</span>';
                    }
                }
                
                const skippedStyle = isSkipped ? 'opacity: 0.6;' : '';
                
                return `
                    <div class="action-log-item ${actionClass}" style="${skippedStyle}">
                        <strong>${entry.pcName}</strong>: ${entry.action}${methodBadge}
                        <div class="action-log-time">${entry.timestamp}</div>
                    </div>
                `;
            }).join('');
        }

        function showConfigSection() {
            // Config section is always visible when advanced features are shown
            // This button just ensures it's visible (no-op now, kept for compatibility)
            document.getElementById('show-config-btn').style.display = 'none';
        }

        function saveConfig() {
            config.url = document.getElementById('pikvm-url').value.trim();
            config.username = document.getElementById('pikvm-username').value;
            config.password = document.getElementById('pikvm-password').value;

            if (!config.url) {
                config.url = window.location.hostname;
            }

            localStorage.setItem('pikvm_url', config.url);
            localStorage.setItem('pikvm_username', config.username);
            localStorage.setItem('pikvm_password', config.password);

            showToast('Credentials updated!', 'success');
            
            // Config section remains visible when advanced features are shown
            // No need to hide it anymore
            
            checkAllStatus();
            startStatusChecking();
        }

        async function clearConfig() {
            const confirmed = await showConfirmModal(
                ' Clear Credentials',
                'Are you sure you want to clear the saved credentials? You will need to re-enter them.'
            );
            
            if (confirmed) {
                localStorage.removeItem('pikvm_url');
                localStorage.removeItem('pikvm_username');
                localStorage.removeItem('pikvm_password');
                
                config = { url: '', username: 'admin', password: '' };
                
                document.getElementById('pikvm-url').value = '';
                document.getElementById('pikvm-username').value = 'admin';
                document.getElementById('pikvm-password').value = '';
                
                // Config section visibility is managed by advanced-feature class
                
                for (let i = 0; i < 2; i++) {
                    document.getElementById(`status-dot-${i}`).className = 'status-dot checking';
                    document.getElementById(`status-text-${i}`).textContent = 'Credentials Required';
                }
                
                showToast('Credentials cleared', 'info');
            }
        }

        async function cleanupUnusedIcons() {
            const confirmed = await showConfirmModal(
                ' Clean Up Icons',
                'Remove all uploaded icons that are not currently in use?'
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await fetch('/api/dashboard/cleanup-icons', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (result.deleted.length > 0) {
                        showToast(` ${result.message}: ${result.deleted.join(', ')}`, 'success');
                    } else {
                        showToast(' No unused icons found', 'info');
                    }
                } else {
                    showToast(` Cleanup failed: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Cleanup error:', error);
                showToast(' Failed to cleanup icons', 'error');
            }
        }

        // ============ CONFIRMATION MODAL ============
        let confirmModalCallback = null;

        function showConfirmModal(title, message) {
            return new Promise((resolve) => {
                document.getElementById('confirmModalTitle').textContent = title;
                document.getElementById('confirmModalText').textContent = message;
                const modal = document.getElementById('confirmModal');
                modal.classList.add('show');
                
                confirmModalCallback = resolve;
                
                // Add click outside to cancel
                setTimeout(() => {
                    modal.onclick = function(e) {
                        if (e.target === modal) {
                            closeConfirmModal(false);
                        }
                    };
                }, 100);
            });
        }

        function closeConfirmModal(confirmed) {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('show');
            modal.onclick = null; // Remove click handler
            
            if (confirmModalCallback) {
                confirmModalCallback(confirmed);
                confirmModalCallback = null;
            }
        }

        // ============ ABOUT MODAL ============
        function showAboutModal() {
            const modal = document.getElementById('aboutModal');
            modal.classList.add('show');
            
            // Close when clicking outside
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeAboutModal();
                }
            };
        }
        
        function closeAboutModal() {
            const modal = document.getElementById('aboutModal');
            modal.classList.remove('show');
            modal.onclick = null;
        }

        // ============ TOAST NOTIFICATIONS ============
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ============ BROWSER NOTIFICATIONS ============
        
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showToast('Browser notifications not supported', 'error');
                return false;
            }
            
            if (Notification.permission === 'granted') {
                return true;
            }
            
            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }
            
            return false;
        }
        
        async function toggleNotificationsFromMenu() {
            // Toggle the state (like toggleSound does)
            const wasEnabled = notificationsEnabled;
            
            if (!wasEnabled) {
                // Trying to enable - need permission
                const granted = await requestNotificationPermission();
                if (granted) {
                    notificationsEnabled = true;
                    localStorage.setItem('notifications_enabled', 'true');
                    showToast('Notifications enabled', 'success');
                    
                    // Show a test notification
                    new Notification('PiKVM Dashboard', {
                        body: 'Notifications are now enabled! You\'ll be notified when scheduled actions run.',
                        icon: '/logo.png'
                    });
                } else {
                    showToast('Notification permission denied', 'error');
                }
            } else {
                // Disabling
                notificationsEnabled = false;
                localStorage.setItem('notifications_enabled', 'false');
                showToast('Notifications disabled', 'info');
            }
            updateMenuNotifyText();
        }
        
        function updateMenuNotifyText() {
            const icon = document.getElementById('menuNotifyIcon');
            const text = document.getElementById('menuNotifyText');
            const toggle = document.getElementById('menuNotifyToggle');
            
            if (notificationsEnabled && Notification.permission === 'granted') {
                if (icon) icon.textContent = '';
                if (text) text.textContent = 'Notifications On';
                if (toggle) toggle.checked = true;
            } else {
                if (icon) icon.textContent = '';
                if (text) text.textContent = 'Notifications Off';
                if (toggle) toggle.checked = false;
            }
        }
        
        function showNotification(action) {
            if (!notificationsEnabled || Notification.permission !== 'granted') {
                return;
            }
            
            const actionText = action.action.replace('Recurring ', '').replace('Scheduled ', '');
            const title = `PiKVM: ${action.pcName}`;
            const body = `${actionText} executed`;
            
            try {
                new Notification(title, {
                    body: body,
                    icon: '/logo.png',
                    tag: `pikvm-${action.timestamp}`, // Prevent duplicate notifications
                    requireInteraction: false
                });
            } catch (e) {
                console.error('Failed to show notification:', e);
            }
        }

        async function makeRequest(endpoint, method = 'POST') {
            const url = endpoint.startsWith('http') ? endpoint : endpoint;
            
            try {
                const response = await fetch(url, {
                    method: method,
                    credentials: 'same-origin',
                });

                if (!response.ok) {
                    console.error('Request failed:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('Error details:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                return await response.json();
            } catch (error) {
                console.error('Request failed:', error);
                showToast('Request failed: ' + error.message, 'error');
                return null;
            }
        }

        async function checkStatus(port) {
            if (port === null || port === undefined) {
                console.error('checkStatus called with invalid port:', port);
                return;
            }
            
            const data = await makeRequest('/api/switch', 'GET');
            
            const statusDot = document.getElementById(`status-dot-${port}`);
            const statusText = document.getElementById(`status-text-${port}`);
            const hddLed = document.getElementById(`hdd-led-${port}`);
            const btnOn = document.getElementById(`btn-on-${port}`);
            const btnOff = document.getElementById(`btn-off-${port}`);
            const btnReset = document.getElementById(`btn-reset-${port}`);

            if (!data) {
                statusDot.className = 'status-dot checking';
                statusText.textContent = 'Connection Error';
                return;
            }

            const powerArray = data.result?.atx?.leds?.power;
            const hddArray = data.result?.atx?.leds?.hdd;
            
            const isOn = powerArray?.[port] === true;
            const hddActive = hddArray?.[port] === true;
            
            statusDot.className = `status-dot ${isOn ? 'on' : 'off'}`;
            statusText.textContent = isOn ? 'Power: ON' : 'Power: OFF';
            
            if (hddLed) {
                hddLed.className = hddActive ? 'led-dot active' : 'led-dot';
            }
            
            btnOn.disabled = isOn;
            btnOff.disabled = !isOn;
            btnReset.disabled = !isOn;
        }

        function showShutdownModal(port, pcName) {
            window.selectedPort = port;
            window.selectedPCName = pcName;
            window.selectedAction = 'off';
            
            const modal = document.getElementById('shutdownModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalText = document.getElementById('modalText');
            const modalButtons = document.getElementById('modalButtons');
            
            modalTitle.textContent = ` Shutdown ${pcName}`;
            modalText.textContent = 'Choose shutdown method:';
            modalButtons.innerHTML = `
                <button class="modal-btn modal-btn-secondary tooltip" 
                        data-tooltip="Short press - simulates pressing power button for graceful shutdown"
                        onclick="executeAction('short-press')">
                    Safe Shutdown (Short Press)
                </button>
                <button class="modal-btn modal-btn-primary tooltip" 
                        data-tooltip="Long press - holds power button to force immediate shutdown"
                        onclick="executeAction('long-press')">
                    Force Shutdown (Long Press)
                </button>
                <button class="modal-btn modal-btn-cancel" onclick="closeModal()">Cancel</button>
            `;
            
            modal.classList.add('show');
            
            // Add click outside to cancel
            setTimeout(() => {
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        closeModal();
                    }
                };
            }, 100);
        }
        
        function showResetModal(port, pcName) {
            window.selectedPort = port;
            window.selectedPCName = pcName;
            window.selectedAction = 'reset';
            
            const modal = document.getElementById('shutdownModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalText = document.getElementById('modalText');
            const modalButtons = document.getElementById('modalButtons');
            
            modalTitle.textContent = ` Reset ${pcName}`;
            modalText.textContent = 'Choose reset method:';
            modalButtons.innerHTML = `
                <button class="modal-btn modal-btn-secondary tooltip" 
                        data-tooltip="Short press - simulates pressing reset button for graceful restart"
                        onclick="executeAction('short-reset')">
                    Safe Reset (Short Press)
                </button>
                <button class="modal-btn modal-btn-primary tooltip" 
                        data-tooltip="Long press - holds reset button to force immediate restart"
                        onclick="executeAction('long-reset')">
                    Force Reset (Long Press)
                </button>
                <button class="modal-btn modal-btn-cancel" onclick="closeModal()">Cancel</button>
            `;
            
            modal.classList.add('show');
            
            // Add click outside to cancel
            setTimeout(() => {
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        closeModal();
                    }
                };
            }, 100);
        }

        function executeAction(method) {
            confirmAction(method, window.selectedPort);
        }

        function closeModal() {
            const modal = document.getElementById('shutdownModal');
            modal.classList.remove('show');
            modal.onclick = null; // Remove click handler
            currentPort = null;
            currentAction = null;
        }

        async function confirmAction(method, port) {
            if (isProcessingCommand) {
                showToast('Please wait, processing previous command...', 'info');
                return;
            }
            
            if (port === null || port === undefined) {
                console.error('confirmAction called with invalid port:', port);
                showToast('Error: Invalid port selected', 'error');
                closeModal();
                return;
            }
            
            const config = window.dashboardConfig;
            if (!config) {
                showToast('Configuration not loaded', 'error');
                return;
            }
            
            isProcessingCommand = true;
            closeModal();
            
            const waitTime = 30000;
            const pcName = window.selectedPCName || `PC ${port}`;
            const hasSwitch = config.hardware.hasSwitch;
            
            if (method === 'short-reset' || method === 'long-reset') {
                setProcessingState(port, 'resetting', waitTime);
                
                let url;
                if (method === 'short-reset') {
                    url = hasSwitch ? `/api/switch/atx/click?port=${port}&button=reset` : `/api/atx/click?button=reset`;
                    showToast('Safe reset signal sent (short press)', 'success');
                    logAction(pcName, 'Safe reset (short press)', 'reset');
                } else {
                    url = hasSwitch ? `/api/switch/atx/power?port=${port}&action=reset_hard` : `/api/atx/power?action=reset_hard`;
                    showToast('Force reset signal sent (long press)', 'success');
                    logAction(pcName, 'Force reset (long press)', 'reset');
                }
                
                await makeRequest(url);
                
                setTimeout(() => {
                    clearProcessingState(port);
                    checkStatus(port);
                    isProcessingCommand = false;
                }, waitTime);
                
            } else if (method === 'short-press' || method === 'long-press') {
                setProcessingState(port, 'shutting-down', waitTime);
                
                let url;
                if (method === 'short-press') {
                    url = hasSwitch ? `/api/switch/atx/click?port=${port}&button=power` : `/api/atx/click?button=power`;
                    showToast('Safe shutdown signal sent (short press)', 'success');
                    logAction(pcName, 'Safe shutdown (short press)', 'shutdown');
                } else {
                    url = hasSwitch ? `/api/switch/atx/click?port=${port}&button=power_long` : `/api/atx/click?button=power_long`;
                    showToast('Force shutdown signal sent (long press)', 'success');
                    logAction(pcName, 'Force shutdown (long press)', 'shutdown');
                }
                
                await makeRequest(url);
                
                setTimeout(() => {
                    clearProcessingState(port);
                    checkStatus(port);
                    isProcessingCommand = false;
                }, waitTime);
            }
            
            playSound('success');
        }

        async function powerOn(port, pcName) {
            if (isProcessingCommand) {
                showToast('Please wait, processing previous command...', 'info');
                return;
            }
            
            const config = window.dashboardConfig;
            if (!config) {
                showToast('Configuration not loaded', 'error');
                return;
            }
            
            isProcessingCommand = true;
            setProcessingState(port, 'powering-on', 30000);
            
            // Use correct API based on switch configuration
            let url;
            if (config.hardware.hasSwitch) {
                url = `/api/switch/atx/power?port=${port}&action=on`;
            } else {
                url = `/api/atx/power?action=on`;
            }
            
            await makeRequest(url);
            
            showToast('Power on signal sent', 'success');
            playSound('success');
            logAction(pcName, 'Power on', 'power-on');
            
            setTimeout(() => {
                clearProcessingState(port);
                checkStatus(port);
                isProcessingCommand = false;
            }, 30000);
        }

        function setProcessingState(port, action, durationMs) {
            processingPorts[port] = {
                action: action,
                endTime: Date.now() + durationMs
            };
            
            const btnOn = document.getElementById(`btn-on-${port}`);
            const btnOff = document.getElementById(`btn-off-${port}`);
            const btnReset = document.getElementById(`btn-reset-${port}`);
            
            btnOn.disabled = true;
            btnOff.disabled = true;
            btnReset.disabled = true;
            
            const statusText = document.getElementById(`status-text-${port}`);
            const statusDot = document.getElementById(`status-dot-${port}`);
            statusText.className = 'status-text processing';
            statusDot.className = 'status-dot checking';
            
            if (action === 'powering-on') {
                statusText.textContent = 'Starting up...';
            } else if (action === 'shutting-down') {
                statusText.textContent = 'Shutting down...';
            } else if (action === 'resetting') {
                statusText.textContent = 'Restarting...';
            }
            
            updateProcessingCountdown();
        }

        function clearProcessingState(port) {
            delete processingPorts[port];
            const statusText = document.getElementById(`status-text-${port}`);
            statusText.className = 'status-text';
        }

        function updateProcessingCountdown() {
            const now = Date.now();
            
            for (const port in processingPorts) {
                const processing = processingPorts[port];
                const secondsLeft = Math.ceil((processing.endTime - now) / 1000);
                const countdownEl = document.getElementById(`countdown-${port}`);
                
                if (secondsLeft > 0) {
                    countdownEl.textContent = `Checking status in ${secondsLeft}s`;
                    countdownEl.className = 'countdown processing';
                } else {
                    countdownEl.textContent = 'Checking status...';
                }
            }
        }

        function updateCountdown() {
            if (!nextCheckTime) return;
            
            const now = Date.now();
            const secondsLeft = Math.ceil((nextCheckTime - now) / 1000);
            
            for (let i = 0; i < 2; i++) {
                if (processingPorts[i]) continue;
                
                const countdownEl = document.getElementById(`countdown-${i}`);
                if (secondsLeft > 0) {
                    countdownEl.textContent = `Next check in ${secondsLeft}s`;
                    countdownEl.className = 'countdown';
                } else {
                    countdownEl.textContent = 'Checking...';
                }
            }
            
            updateProcessingCountdown();
        }

        function checkAllStatus() {
            // Check all configured PCs
            const config = window.dashboardConfig;
            if (config && config.pcs) {
                config.pcs.forEach(pc => {
                    checkStatus(pc.port);
                });
            } else {
                // Fallback for backwards compatibility
                checkStatus(0);
                checkStatus(1);
            }
            nextCheckTime = Date.now() + 30000;
        }

        async function updateUptime() {
            const uptimeData = await apiRequest('/uptime');
            const config = window.dashboardConfig;
            
            if (uptimeData && config && config.pcs) {
                config.pcs.forEach(pc => {
                    const port = pc.port;
                    const portData = uptimeData[port.toString()];
                    const uptimeEl = document.getElementById(`uptime-${port}`);
                    
                    if (uptimeEl) {
                        if (portData && portData.currentUptime > 0) {
                            const seconds = portData.currentUptime;
                            const days = Math.floor(seconds / 86400);
                            const hours = Math.floor((seconds % 86400) / 3600);
                            const minutes = Math.floor((seconds % 3600) / 60);
                            
                            let uptimeStr = 'Uptime: ';
                            if (days > 0) uptimeStr += `${days}d `;
                            if (hours > 0 || days > 0) uptimeStr += `${hours}h `;
                            uptimeStr += `${minutes}m`;
                            
                            uptimeEl.textContent = uptimeStr;
                        } else {
                            uptimeEl.textContent = 'Uptime: --';
                        }
                    }
                });
            }
        }

        async function updateHDDStatus() {
            const data = await makeRequest('/api/switch', 'GET');
            const config = window.dashboardConfig;
            
            if (!data || !config || !config.pcs) return;
            
            const hddArray = data.result?.atx?.leds?.hdd;
            
            config.pcs.forEach(pc => {
                const port = pc.port;
                const hddLed = document.getElementById(`hdd-led-${port}`);
                const hddActive = hddArray?.[port] === true;
                
                if (hddLed) {
                    hddLed.className = hddActive ? 'led-dot active' : 'led-dot';
                }
            });
        }

        function startStatusChecking() {
            if (statusCheckInterval) clearInterval(statusCheckInterval);
            if (countdownInterval) clearInterval(countdownInterval);
            
            // Full status check every 30 seconds
            statusCheckInterval = setInterval(() => {
                if (!isProcessingCommand) {
                    checkAllStatus();
                    updateUptime();
                }
            }, 30000);
            
            // HDD activity check every second (lightweight)
            setInterval(() => {
                updateHDDStatus();
            }, 1000);
            
            nextCheckTime = Date.now() + 30000;
            countdownInterval = setInterval(updateCountdown, 1000);
        }
        
        // Scroll to Top functionality
        function initScrollToTop() {
            const scrollBtn = document.getElementById('scrollToTopBtn');
            if (!scrollBtn) return;
            
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    scrollBtn.classList.add('show');
                } else {
                    scrollBtn.classList.remove('show');
                }
            });
            
            scrollBtn.addEventListener('click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        }
        
        // Initialize scroll to top when DOM is ready
        document.addEventListener('DOMContentLoaded', initScrollToTop);
    </script>
    
    <!-- Scroll to Top Button -->
    <button class="scroll-to-top" id="scrollToTopBtn" title="Scroll to top">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <polyline points="18 15 12 9 6 15" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>
</body>
</html>